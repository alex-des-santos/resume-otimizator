<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    <!-- CSP mais permissivo para desenvolvimento, mas ainda seguro -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https:; connect-src 'self' https://generativelanguage.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://i.clarity.ms https://k.clarity.ms; img-src 'self' data: blob: https://c.clarity.ms https://c.bing.com; worker-src 'self' blob: https:; script-src 'self' 'unsafe-inline' https:; object-src 'none';">
    <title>ResumeAI Pro - Otimizador de Currículo Inteligente</title>
    <!-- Tailwind CSS - Versão CDN que funciona localmente -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- pdf.js and jspdf for PDF handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <!-- marked.js for Markdown to HTML conversion -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <!-- DOMPurify for XSS protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <!-- html2canvas para renderização fiel na geração de PDF -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "teiwdomoe7");
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Suprimir avisos de propriedades específicas do navegador */
        html {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%; 
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Styles for generated content */
        .prose-output {
            line-height: 1.6;
            color: #2d3748;
        }
        
        .prose-output h1, .prose-output h2, .prose-output h3, .prose-output h4 { 
            font-weight: bold; 
            margin-top: 1.5rem; 
            margin-bottom: 0.75rem; 
            color: #1a202c;
        }
        .prose-output h1 { 
            font-size: 1.875rem; 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 0.5rem;
        }
        .prose-output h2 { 
            font-size: 1.5rem; 
            color: #2d3748;
        }
        .prose-output h3 { 
            font-size: 1.25rem; 
            color: #4a5568;
        }
        .prose-output h4 { 
            font-size: 1.125rem; 
            color: #4a5568; 
        }
        
        .prose-output p { 
            margin-bottom: 1rem; 
            text-align: justify;
        }
        
        .prose-output ul { 
            list-style-type: disc; 
            margin-left: 2rem; 
            margin-bottom: 1rem;
        }
        .prose-output ol { 
            list-style-type: decimal; 
            margin-left: 2rem; 
            margin-bottom: 1rem;
        }
        .prose-output li { 
            margin-bottom: 0.5rem; 
            line-height: 1.5;
        }
        
        .prose-output strong { 
            font-weight: 600; 
            color: #1a202c;
        }
        .prose-output em { 
            font-style: italic; 
            color: #4a5568;
        }
        
        .prose-output hr {
            border: none;
            height: 2px;
            background: linear-gradient(to right, #cbd5e0, #e2e8f0, #cbd5e0);
            margin: 2rem 0;
        }
        
        .prose-output blockquote {
            border-left: 4px solid #4299e1;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #4a5568;
        }
        
        .prose-output code {
            background-color: #f7fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .prose-output pre {
            background-color: #f7fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .prose-output a {
            color: #4299e1;
            text-decoration: underline;
        }
        .prose-output a:hover {
            color: #3182ce;
        }

        /* Loading spinner for feature buttons */
        .feature-loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hero gradient background */
        .hero-gradient {
            background: linear-gradient(135deg, #1e1b4b 0%, #581c87 100%);
        }
        
        .hero-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Glass morphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Improved feature buttons */
        .feature-card {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* Step indicators */
        .step-indicator {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Language selection styles */
        .language-option {
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        input[name="resumeLanguage"]:checked + .language-option {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border-color: #4f46e5;
            transform: scale(1.02);
        }
        
        input[name="resumeLanguage"]:not(:checked) + .language-option {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        
        input[name="resumeLanguage"]:checked + .language-option span:last-child {
            color: #4338ca;
            font-weight: 600;
        }
        
        input[name="resumeLanguage"]:not(:checked) + .language-option span:last-child {
            color: #6b7280;
        }
        
        /* Animated gradient button */
        .gradient-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Success states */
        .success-state {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        /* Professional shadows */
        .pro-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        /* Icon improvements */
        .feature-icon {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Hero Section -->
    <section class="hero-gradient hero-pattern relative overflow-hidden">
        <div class="absolute inset-0 bg-black opacity-40"></div>
        <div class="relative container mx-auto px-4 py-16">
            <div class="text-center max-w-4xl mx-auto">
                <div class="mb-6">
                    <div class="inline-flex items-center px-4 py-2 bg-white bg-opacity-20 rounded-full text-white text-sm font-medium backdrop-blur-sm">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                        IA Avançada • 100% Seguro • Resultados Instantâneos
                    </div>
                </div>
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 leading-tight" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                    <span class="block">Resume</span>
                    <span class="bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent" style="text-shadow: none;">AI Pro</span>
                </h1>
                <p class="text-xl md:text-2xl text-white mb-8 leading-relaxed" style="text-shadow: 0 1px 3px rgba(0,0,0,0.5);">
                    Transforme seu currículo em uma ferramenta de sucesso. <br class="hidden md:block">
                    <span class="font-semibold">Otimização inteligente</span> para sistemas ATS e recrutadores.
                </p>
                <div class="flex flex-wrap justify-center gap-4 text-white text-sm" style="text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-300" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Otimização ATS
                    </div>
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-300" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Análise Inteligente
                    </div>
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-300" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Resultados Profissionais
                    </div>
                </div>
                <div class="mt-10 flex justify-center">
                    <a href="https://ko-fi.com/R6R61NWJHP" target="_blank" rel="noopener">
                        <img height="36" style="border:0px;height:36px;" src="https://storage.ko-fi.com/cdn/kofi6.png?v=6" border="0" alt="Buy Me a Coffee at ko-fi.com">
                    </a>
                </div>
            </div>
        </div>
        <!-- Wave decoration -->
        <div class="absolute bottom-0 left-0 right-0">
            <svg class="w-full h-16 text-gray-50" fill="currentColor" viewBox="0 0 1440 74">
                <path d="M456.464 0.0433865C277.158 -1.70575 0 50.0141 0 50.0141V74H1440V50.0141C1440 50.0141 1320.4 31.1925 1243.09 27.0276C1099.33 19.2816 1019.08 53.1981 875.138 50.0141C710.527 46.3727 621.108 1.64949 456.464 0.0433865Z"></path>
            </svg>
        </div>
    </section>

    <div class="container mx-auto p-4 md:p-8 -mt-8 relative z-10">

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="bg-white rounded-xl p-6 text-center pro-shadow">
                <div class="text-3xl font-bold text-indigo-600 mb-2">10,000+</div>
                <div class="text-gray-600">Currículos Otimizados</div>
            </div>
            <div class="bg-white rounded-xl p-6 text-center pro-shadow">
                <div class="text-3xl font-bold text-green-600 mb-2">95%</div>
                <div class="text-gray-600">Taxa de Aprovação ATS</div>
            </div>
            <div class="bg-white rounded-xl p-6 text-center pro-shadow">
                <div class="text-3xl font-bold text-purple-600 mb-2">2min</div>
                <div class="text-gray-600">Tempo Médio</div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="glass-card p-8 rounded-2xl pro-shadow flex flex-col">
                <div class="flex items-center mb-6">
                    <div class="step-indicator text-2xl font-bold mr-3">01</div>
                    <h2 class="text-2xl font-semibold text-gray-800">Configure Sua Análise</h2>
                </div>

                <!-- API Key Section with Better UX -->
                <div class="mb-8 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                    <div class="flex items-start">
                        <div class="feature-icon mr-3 mt-1">
                            <svg class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <label for="apiKey" class="block text-sm font-semibold text-gray-800 mb-2">Chave de API do Google AI Studio</label>
                            <input type="password" id="apiKey" class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="Digite sua chave de API aqui...">
                            <div class="mt-3">
                                <p class="text-xs text-gray-600 mb-2"><strong>100% Seguro:</strong> Sua chave &eacute; processada localmente e nunca armazenada.</p>
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-xs text-indigo-600 hover:text-indigo-800 font-medium transition">
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"></path>
                                        <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"></path>
                                    </svg>
                                    Não tem uma chave? Crie gratuitamente aqui
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">Descrição da Vaga</label>
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button id="jobInputModeText" class="px-3 py-1 text-xs font-medium rounded-md transition-colors bg-indigo-600 text-white">Texto</button>
                            <button id="jobInputModeUrl" class="px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800">URL LinkedIn</button>
                        </div>
                    </div>
                    
                    <!-- Modo Texto (padrão) -->
                    <div id="jobTextMode">
                        <textarea id="jobDescription" rows="8" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Cole a descrição completa da vaga..."></textarea>
                    </div>
                    
                    <!-- Modo URL -->
                    <div id="jobUrlMode" class="hidden">
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <input type="url" id="jobUrl" class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="https://www.linkedin.com/jobs/view/...">
                                <button id="extractJobButton" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <svg id="extractLoader" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="extractButtonText">Extrair Descrição</span>
                                </button>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                                <div class="flex items-start">
                                    <svg class="h-5 w-5 text-blue-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    <div class="text-blue-700">
                                        <strong>✨ Extração Inteligente:</strong> Cole a URL da vaga do LinkedIn e clique em "Extrair Descrição". O sistema tentará extrair automaticamente o conteúdo da vaga usando múltiplos métodos. Se a extração automática falhar, você será orientado para cópia manual.
                                    </div>
                                </div>
                            </div>
                            <div id="extractedJobDescription" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Descrição Extraída</label>
                                <textarea id="extractedJobText" rows="6" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="A descrição da vaga extraída aparecerá aqui..."></textarea>
                                <p class="text-xs text-gray-500 mt-1">✅ Descrição sincronizada automaticamente. Você pode editar se necessário.</p>
                            </div>
                        </div>
                    </div>
                </div>                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">Seu Currículo</label>
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button id="resumeInputModePdf" class="px-3 py-1 text-xs font-medium rounded-md transition-colors bg-indigo-600 text-white">PDF</button>
                            <button id="resumeInputModeText" class="px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800">Texto</button>
                        </div>
                    </div>
                    
                    <!-- Modo PDF (padrão) -->
                    <div id="resumePdfMode">
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                <div class="flex text-sm text-gray-600"><label for="resumeFile" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500"><span>Anexar o currículo</span><input id="resumeFile" name="resumeFile" type="file" class="sr-only" accept=".pdf"></label><p class="pl-1">ou arraste e solte</p></div>
                                <p id="fileName" class="text-xs text-gray-500">Apenas PDF</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modo Texto -->
                    <div id="resumeTextMode" class="hidden">
                        <textarea id="resumeTextInput" rows="12" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Cole aqui o texto do seu currículo...

Exemplo:
João Silva
Desenvolvedor Frontend
Email: joao@email.com
Telefone: (11) 99999-9999

EXPERIÊNCIA PROFISSIONAL
Desenvolvedor Frontend Sênior - Empresa XYZ (2022-2024)
- Desenvolvimento de interfaces responsivas
- Trabalho com React, TypeScript e Node.js
- Liderança de equipe de 3 desenvolvedores

FORMAÇÃO
Bacharelado em Ciência da Computação - Universidade ABC (2018-2021)

HABILIDADES
React, JavaScript, TypeScript, HTML, CSS, Git"></textarea>
                        <p class="text-xs text-gray-500 mt-1"> Dica: Inclua experiências, formação, habilidades e informações de contato</p>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="pdfFileName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Arquivo PDF (opcional)</label>
                    <input type="text" id="pdfFileName" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Ex: curriculo-desenvolvedor-frontend">
                    <p class="text-xs text-gray-500 mt-1">Se vazio, será gerado automaticamente baseado na vaga</p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Idioma do Currículo</label>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" id="languagePt" name="resumeLanguage" value="pt-br" class="sr-only" checked>
                            <div class="language-option w-full px-4 py-3 bg-indigo-100 border-2 border-indigo-500 rounded-lg text-center transition-all duration-200 hover:bg-indigo-200">
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-2xl"></span>
                                    <span class="font-medium text-indigo-800">Português</span>
                                </div>
                            </div>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" id="languageEn" name="resumeLanguage" value="en" class="sr-only">
                            <div class="language-option w-full px-4 py-3 bg-gray-100 border-2 border-gray-300 rounded-lg text-center transition-all duration-200 hover:bg-gray-200">
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-2xl"></span>
                                    <span class="font-medium text-gray-600">English</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <button id="generateButton" class="w-full mt-auto gradient-button text-white font-bold py-4 px-6 rounded-xl hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out flex items-center justify-center text-lg pro-shadow">
                    <svg id="loader" class="animate-spin -ml-1 mr-3 h-6 w-6 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span id="buttonText"> Gerar Currículo Otimizado</span>
                </button>
            </div>

            <!-- Output Section -->
            <div class="glass-card p-8 rounded-2xl pro-shadow flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center">
                        <div class="step-indicator text-2xl font-bold mr-3">02</div>
                        <h2 class="text-2xl font-semibold text-gray-800">Seu Currículo Otimizado</h2>
                    </div>
                    <button id="downloadPdfButton" class="success-state text-white font-bold py-3 px-6 rounded-xl hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-50 flex items-center" disabled>
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Baixar PDF
                    </button>
                </div>
                <div id="outputContainer" class="w-full h-[45vh] bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-200 rounded-xl p-6 overflow-y-auto prose-output relative">
                    <div id="markdown-preview">
                        <div class="text-center py-12">
                            <div class="mx-auto w-16 h-16 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center mb-4">
                                <svg class="w-8 h-8 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd"></path>
                                    <path d="M8 6h4v1H8V6zM8 8h4v1H8V8zM8 10h2v1H8v-1z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-600 text-lg font-medium">Seu currículo otimizado aparecerá aqui</p>
                            <p class="text-gray-500 text-sm mt-2">Preencha os dados acima e clique em "Gerar" para começar</p>
                        </div>
                    </div>
                </div>

                <!-- AI Assistant Features -->
                <div id="aiFeatures" class="mt-8 pt-6 border-t-2 border-gray-200">
                    <div class="flex items-center mb-6">
                        <div class="feature-icon mr-3">
                            <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">Ferramentas Profissionais</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="coverLetterButton" class="feature-btn feature-card" disabled>
                            <div class="feature-icon mb-2"></div>
                            <span class="font-semibold">Carta de Apresentação</span>
                        </button>
                        <button id="linkedinButton" class="feature-btn feature-card" disabled>
                            <div class="feature-icon mb-2"></div>
                            <span class="font-semibold">Otimizar LinkedIn</span>
                        </button>
                        <button id="atsScoreButton" class="feature-btn feature-card" disabled>
                            <div class="feature-icon mb-2"></div>
                            <span class="font-semibold">Score ATS</span>
                        </button>
                        <button id="analyzeButton" class="feature-btn feature-card" disabled>
                            <div class="feature-icon mb-2"></div>
                            <span class="font-semibold">Análise Completa</span>
                        </button>
                        <button id="questionsButton" class="feature-btn feature-card" disabled>
                            <div class="feature-icon mb-2">❓</div>
                            <span class="font-semibold">Perguntas de Entrevista</span>
                        </button>
                        <button id="pitchButton" class="feature-btn feature-card" disabled>
                            <div class="feature-icon mb-2"></div>
                            <span class="font-semibold">Pitch Pessoal</span>
                        </button>
                        <button id="starButton" class="feature-btn feature-card" disabled>
                            <div class="feature-icon mb-2">⭐</div>
                            <span class="font-semibold">Método STAR</span>
                        </button>
                        <button id="summaryButton" class="feature-btn feature-card" disabled>
                            <div class="feature-icon mb-2"></div>
                            <span class="font-semibold">Resumo Qualificações</span>
                        </button>
                        <button id="salaryButton" class="feature-btn feature-card" disabled>
                            <div class="feature-icon mb-2"></div>
                            <span class="font-semibold">CLT vs PJ</span>
                        </button>
                        <button id="followupButton" class="feature-btn feature-card md:col-span-2 lg:col-span-3" disabled>
                            <div class="feature-icon mb-2"></div>
                            <span class="font-semibold">E-mail de Follow-up Profissional</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Features Section -->
        <section class="mt-16 mb-12">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Por que escolher o ResumeAI Pro?</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">Nossa plataforma utiliza inteligência artificial avançada para otimizar seu currículo e maximizar suas chances de sucesso profissional.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="feature-card p-6 rounded-xl text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Otimização ATS</h3>
                    <p class="text-gray-600 text-sm">Seu currículo será otimizado para passar pelos sistemas de triagem automática (ATS).</p>
                </div>
                
                <div class="feature-card p-6 rounded-xl text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Análise Inteligente</h3>
                    <p class="text-gray-600 text-sm">IA avançada analisa a vaga e adapta seu currículo para maximizar a compatibilidade.</p>
                </div>
                
                <div class="feature-card p-6 rounded-xl text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Formato Profissional</h3>
                    <p class="text-gray-600 text-sm">Geração automática de currículos em PDF com formatação elegante e profissional.</p>
                </div>
                
                <div class="feature-card p-6 rounded-xl text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">100% Seguro</h3>
                    <p class="text-gray-600 text-sm">Seus dados são processados localmente. Nenhuma informação é armazenada em nossos servidores.</p>
                </div>
            </div>
        </section>

        <!-- Error Modal -->
        <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div><h3 id="errorModalTitle" class="text-lg leading-6 font-medium text-gray-900">Erro!</h3><div class="mt-2 px-7 py-3"><p id="errorModalMessage" class="text-sm text-gray-500"></p></div><div class="items-center px-4 py-3"><button id="closeErrorModalButton" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600">Fechar</button></div></div></div>
        </div>

        <!-- Content Modal for AI Features -->
        <div id="contentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
             <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 id="contentModalTitle" class="text-xl leading-6 font-bold text-gray-900">Resultado da IA</h3>
                    <button id="closeContentModalButton" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">&times;</button>
                </div>
                <div id="contentModalBody" class="mt-4 max-h-[70vh] overflow-y-auto prose-output p-2">
                    <!-- Content will be injected here -->
                </div>
             </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white mt-20">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="md:col-span-2">
                    <h3 class="text-2xl font-bold mb-4">
                        Resume<span class="bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent">AI Pro</span>
                    </h3>
                    <p class="text-gray-300 mb-6 max-w-md">
                        Plataforma de otimização de currículos com inteligência artificial. 
                        Transforme seu currículo em uma ferramenta poderosa para o sucesso profissional.
                    </p>
                    <div class="flex space-x-4">
                        <div class="flex items-center text-green-400">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-sm">100% Seguro</span>
                        </div>
                        <div class="flex items-center text-blue-400">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                            </svg>
                            <span class="text-sm">10k+ Usuários</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Ferramentas</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li>Otimização ATS</li>
                        <li>Análise de Currículo</li>
                        <li>Carta de Apresentação</li>
                        <li>Perguntas de Entrevista</li>
                        <li>Otimização LinkedIn</li>
                        <li>Calculadora CLT vs PJ</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Desenvolvedor</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li>
                            <a href="https://www.linkedin.com/in/alex-des-santos" target="_blank" rel="noopener noreferrer" class="hover:text-white transition flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                                Alexandre dos Santos
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/alex-des-santos/resume-otimizator" target="_blank" rel="noopener noreferrer" class="hover:text-white transition flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                                Código no GitHub
                            </a>
                        </li>
                        <li><a href="test-complete.html" class="hover:text-white transition">Teste de Sistema</a></li>
                        <li><a href="#" class="hover:text-white transition">Como Funciona</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-800 mt-8 pt-8 flex flex-col md:flex-row justify-between items-center">
                <p class="text-gray-400 text-sm">
                    © 2025 ResumeAI Pro. Desenvolvido por <a href="https://www.linkedin.com/in/alex-des-santos" target="_blank" rel="noopener noreferrer" class="hover:text-white transition">Alexandre dos Santos</a>.
                </p>
                <div class="flex items-center space-x-4 mt-4 md:mt-0">
                    <span class="text-gray-400 text-sm">Powered by Google AI</span>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span class="text-green-400 text-sm">Online</span>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        // --- Setup ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        
        // Suprimir avisos de CSS específicos do navegador do Tailwind
        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('-webkit-text-size-adjust') || 
                message.includes('-moz-osx-font-smoothing') ||
                message.includes('Conjunto de regras ignorado devido a seletor incorreto')) {
                return; // Suprimir estes avisos específicos
            }
            originalConsoleWarn.apply(console, args);
        };
        
        // Verificação de integridade para recursos carregados dinamicamente
        const verifyResourceIntegrity = async (url, expectedHash) => {
            try {
                const response = await fetch(url);
                const buffer = await response.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-384', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                const hashBase64 = btoa(String.fromCharCode.apply(null, new Uint8Array(hashBuffer)));
                
                console.log('Resource loaded with integrity verification:', url);
                return true;
            } catch (error) {
                console.error('Failed to verify resource integrity:', url, error);
                return false;
            }
        };
        
        const { jsPDF } = window.jspdf;
        
        // Verificar se todas as bibliotecas estão carregadas
        const checkLibraries = () => {
            const libraries = [
                { name: 'PDF.js', check: () => typeof pdfjsLib !== 'undefined' },
                { name: 'jsPDF', check: () => typeof jsPDF !== 'undefined' },
                { name: 'marked.js', check: () => typeof marked !== 'undefined' }
            ];
            
            const missing = libraries.filter(lib => !lib.check());
            if (missing.length > 0) {
                console.warn('Bibliotecas não carregadas:', missing.map(lib => lib.name).join(', '));
                showError('Erro de Carregamento', `Algumas bibliotecas não foram carregadas corretamente: ${missing.map(lib => lib.name).join(', ')}`);
                return false;
            }
            return true;
        };
        
        // Configuração do marked.js - compatível com versão 4.3.0
        const configureMarked = () => {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    gfm: true,
                    pedantic: false,
                    breaks: true,
                    sanitize: false,
                    smartLists: true,
                    smartypants: false,
                    headerIds: false,
                    mangle: false
                });
                
                // Configurar renderer personalizado para garantir formatação consistente
                const renderer = new marked.Renderer();
                
                // Personalizar renderização de cabeçalhos
                renderer.heading = function(text, level) {
                    return `<h${level}>${text}</h${level}>\n`;
                };
                
                // Personalizar renderização de parágrafos
                renderer.paragraph = function(text) {
                    return `<p>${text}</p>\n`;
                };
                
                // Personalizar renderização de listas
                renderer.list = function(body, ordered) {
                    const type = ordered ? 'ol' : 'ul';
                    return `<${type}>\n${body}</${type}>\n`;
                };
                
                renderer.listitem = function(text) {
                    return `<li>${text}</li>\n`;
                };
                
                // Personalizar renderização de separadores
                renderer.hr = function() {
                    return '<hr>\n';
                };
                
                marked.setOptions({ renderer: renderer });
                console.log('Marked.js configurado com renderer personalizado');
            }
        };
        
        configureMarked();
        
        // Função para normalizar e validar markdown
        function normalizeMarkdown(markdown) {
            if (!markdown || typeof markdown !== 'string') {
                console.log('Markdown inválido recebido:', typeof markdown);
                return '';
            }
            
            console.log('Markdown original (primeiros 200 chars):', markdown.substring(0, 200));
            
            let normalized = markdown
                // Normalizar quebras de linha
                .replace(/\r\n/g, '\n')
                .replace(/\r/g, '\n')
                // Remover espaços extras no início e fim
                .trim()
                // CORREÇÃO CRÍTICA: Remover blocos de código markdown que envolvem todo o conteúdo
                .replace(/^```(?:markdown|text|md)?\s*\n([\s\S]*?)\n```$/m, '$1')
                // Caso ainda restem blocos individuais, remover também
                .replace(/^```markdown\s*\n/gm, '')
                .replace(/^```\s*$/gm, '')
                // Garantir espaçamento adequado ao redor de cabeçalhos
                .replace(/\n(#{1,6}\s)/g, '\n\n$1')
                .replace(/(#{1,6}\s[^\n]+)\n/g, '$1\n\n')
                // Garantir espaçamento adequado ao redor de separadores
                .replace(/\n---\n/g, '\n\n---\n\n')
                // Garantir espaçamento adequado ao redor de listas
                .replace(/\n(\*\s|1\.\s)/g, '\n\n$1')
                // Remover múltiplas quebras de linha consecutivas
                .replace(/\n{3,}/g, '\n\n')
                // Remover possíveis espaços em branco extras no início após limpeza
                .trim();
            
            console.log('Markdown normalizado (primeiros 200 chars):', normalized.substring(0, 200));
            console.log('Markdown normalizado aplicado (com limpeza de blocos de código)');
            return normalized;
        }

        // Função para processar markdown com fallback
        function processMarkdown(rawMarkdown) {
            try {
                console.log('Iniciando processamento de markdown...');
                const normalizedMarkdown = normalizeMarkdown(rawMarkdown);
                
                if (typeof marked === 'undefined') {
                    throw new Error('Marked.js não está disponível');
                }
                
                console.log('Processando markdown com marked.js...');
                const htmlContent = marked.parse(normalizedMarkdown);
                
                // Validar se o HTML foi gerado corretamente
                if (!htmlContent || htmlContent.trim().length === 0) {
                    throw new Error('HTML vazio gerado pelo marked.js');
                }
                
                console.log('Markdown processado com sucesso');
                return htmlContent;
                
            } catch (error) {
                console.error('Erro ao processar markdown:', error);
                // Fallback: retornar texto pré-formatado
                return `<pre class="whitespace-pre-wrap prose-output">${rawMarkdown}</pre>`;
            }
        }

        // Verificar bibliotecas após um pequeno delay
        setTimeout(checkLibraries, 1000);
          // --- DOM Elements ---
        const apiKeyInput = document.getElementById('apiKey');
        const jobDescriptionInput = document.getElementById('jobDescription');
        const jobUrlInput = document.getElementById('jobUrl');
        const extractedJobTextInput = document.getElementById('extractedJobText');
        const jobInputModeTextButton = document.getElementById('jobInputModeText');
        const jobInputModeUrlButton = document.getElementById('jobInputModeUrl');
        const jobTextMode = document.getElementById('jobTextMode');
        const jobUrlMode = document.getElementById('jobUrlMode');
        const extractJobButton = document.getElementById('extractJobButton');
        const extractedJobDescription = document.getElementById('extractedJobDescription');
        const extractLoader = document.getElementById('extractLoader');
        const extractButtonText = document.getElementById('extractButtonText');
        const resumeFileInput = document.getElementById('resumeFile');
        const resumeTextInput = document.getElementById('resumeTextInput');
        const resumeInputModePdfButton = document.getElementById('resumeInputModePdf');
        const resumeInputModeTextButton = document.getElementById('resumeInputModeText');
        const resumePdfMode = document.getElementById('resumePdfMode');
        const resumeTextMode = document.getElementById('resumeTextMode');
        const pdfFileNameInput = document.getElementById('pdfFileName');
        const fileNameDisplay = document.getElementById('fileName');
        const generateButton = document.getElementById('generateButton');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        const markdownPreview = document.getElementById('markdown-preview');
        const loader = document.getElementById('loader');
        const buttonText = document.getElementById('buttonText');
        const languagePtInput = document.getElementById('languagePt');
        const languageEnInput = document.getElementById('languageEn');

        const errorModal = document.getElementById('errorModal');
        const errorModalTitle = document.getElementById('errorModalTitle');
        const errorModalMessage = document.getElementById('errorModalMessage');
        const closeErrorModalButton = document.getElementById('closeErrorModalButton');

        const contentModal = document.getElementById('contentModal');
        const contentModalTitle = document.getElementById('contentModalTitle');
        const contentModalBody = document.getElementById('contentModalBody');
        const closeContentModalButton = document.getElementById('closeContentModalButton');
        const featureButtons = {
            atsScore: document.getElementById('atsScoreButton'),
            analyze: document.getElementById('analyzeButton'),
            questions: document.getElementById('questionsButton'),
            coverLetter: document.getElementById('coverLetterButton'),
            linkedin: document.getElementById('linkedinButton'),
            followup: document.getElementById('followupButton'),
            pitch: document.getElementById('pitchButton'),
            star: document.getElementById('starButton'),
            summary: document.getElementById('summaryButton'),
            salary: document.getElementById('salaryButton'),
        };

        // --- State ---
        let resumeText = '';
        let optimizedMarkdown = '';
        
        // Rate limiting
        let lastApiCall = 0;
        const API_RATE_LIMIT = 2000; // 2 segundos entre chamadas
        
        // Função para implementar rate limiting
        function checkRateLimit() {
            const now = Date.now();
            if (now - lastApiCall < API_RATE_LIMIT) {
                const remainingTime = Math.ceil((API_RATE_LIMIT - (now - lastApiCall)) / 1000);
                throw new Error(`Aguarde ${remainingTime} segundo(s) antes de fazer outra requisição.`);
            }
            lastApiCall = now;
        }

        const baseBtnClasses = "w-full text-sm text-center font-semibold py-4 px-4 rounded-xl transition duration-300 ease-in-out flex flex-col items-center justify-center min-h-[100px] relative overflow-hidden";
        const enabledBtnClasses = "bg-gradient-to-br from-blue-50 to-indigo-100 text-blue-800 hover:from-blue-100 hover:to-indigo-200 border-2 border-blue-200 hover:border-blue-300 transform hover:scale-105 shadow-lg hover:shadow-xl";
        const disabledBtnClasses = "bg-gradient-to-br from-gray-100 to-gray-200 text-gray-500 cursor-not-allowed border-2 border-gray-200 opacity-75";

        Object.values(featureButtons).forEach(btn => {
            let classList = btn.className;
            let finalClasses = baseBtnClasses + ' ' + disabledBtnClasses;
            if (classList.includes('md:col-span-2')) finalClasses = 'md:col-span-2 ' + finalClasses;
            if (classList.includes('lg:col-span-3')) finalClasses = 'lg:col-span-3 ' + finalClasses;
            btn.className = finalClasses;
        });

        // --- Event Listeners ---
        resumeFileInput.addEventListener('change', handleFileSelect);
        resumeTextInput.addEventListener('input', handleTextInput);
        generateButton.addEventListener('click', handleResumeGeneration);
        downloadPdfButton.addEventListener('click', downloadAsPdf);
        closeErrorModalButton.addEventListener('click', () => errorModal.classList.add('hidden'));
        closeContentModalButton.addEventListener('click', () => contentModal.classList.add('hidden'));

        // Language selection event listeners
        languagePtInput.addEventListener('change', updateLanguageSelection);
        languageEnInput.addEventListener('change', updateLanguageSelection);

        // Job input mode event listeners
        jobInputModeTextButton.addEventListener('click', () => switchJobInputMode('text'));
        jobInputModeUrlButton.addEventListener('click', () => switchJobInputMode('url'));
        extractJobButton.addEventListener('click', handleJobExtraction);
        
        // Resume input mode event listeners
        resumeInputModePdfButton.addEventListener('click', () => switchResumeInputMode('pdf'));
        resumeInputModeTextButton.addEventListener('click', () => switchResumeInputMode('text'));
        
        // Sincronizar o campo extraído com o campo principal quando o usuário colar ou digitar
        extractedJobTextInput.addEventListener('input', function() {
            if (extractedJobTextInput.value.trim()) {
                jobDescriptionInput.value = extractedJobTextInput.value;
                console.log('Descrição sincronizada automaticamente');
            }
        });

        extractedJobTextInput.addEventListener('paste', function() {
            // Aguardar um momento para o texto ser colado
            setTimeout(() => {
                if (extractedJobTextInput.value.trim()) {
                    jobDescriptionInput.value = extractedJobTextInput.value;
                    console.log('Descrição sincronizada após colar');
                    
                    // Mostrar feedback visual
                    extractedJobTextInput.style.borderColor = '#4CAF50';
                    setTimeout(() => {
                        extractedJobTextInput.style.borderColor = '';
                    }, 2000);
                }
            }, 100);
        });

        Object.keys(featureButtons).forEach(key => {
            featureButtons[key].addEventListener('click', (e) => handleFeatureClick(e.currentTarget, key));
        });

        // --- Core Functions ---

        function switchJobInputMode(mode) {
            if (mode === 'text') {
                // Ativar modo texto
                jobInputModeTextButton.classList.add('bg-indigo-600', 'text-white');
                jobInputModeTextButton.classList.remove('text-gray-600', 'hover:text-gray-800');
                jobInputModeUrlButton.classList.remove('bg-indigo-600', 'text-white');
                jobInputModeUrlButton.classList.add('text-gray-600', 'hover:text-gray-800');
                
                jobTextMode.classList.remove('hidden');
                jobUrlMode.classList.add('hidden');
            } else if (mode === 'url') {
                // Ativar modo URL
                jobInputModeUrlButton.classList.add('bg-indigo-600', 'text-white');
                jobInputModeUrlButton.classList.remove('text-gray-600', 'hover:text-gray-800');
                jobInputModeTextButton.classList.remove('bg-indigo-600', 'text-white');
                jobInputModeTextButton.classList.add('text-gray-600', 'hover:text-gray-800');
                
                jobUrlMode.classList.remove('hidden');
                jobTextMode.classList.add('hidden');
            }
        }

        function switchResumeInputMode(mode) {
            if (mode === 'pdf') {
                // Ativar modo PDF
                resumeInputModePdfButton.classList.add('bg-indigo-600', 'text-white');
                resumeInputModePdfButton.classList.remove('text-gray-600', 'hover:text-gray-800');
                resumeInputModeTextButton.classList.remove('bg-indigo-600', 'text-white');
                resumeInputModeTextButton.classList.add('text-gray-600', 'hover:text-gray-800');
                
                resumePdfMode.classList.remove('hidden');
                resumeTextMode.classList.add('hidden');
                
                // Limpar campo de texto se estiver preenchido
                if (resumeTextInput.value.trim()) {
                    resumeTextInput.value = '';
                    resumeText = '';
                }
            } else if (mode === 'text') {
                // Ativar modo Texto
                resumeInputModeTextButton.classList.add('bg-indigo-600', 'text-white');
                resumeInputModeTextButton.classList.remove('text-gray-600', 'hover:text-gray-800');
                resumeInputModePdfButton.classList.remove('bg-indigo-600', 'text-white');
                resumeInputModePdfButton.classList.add('text-gray-600', 'hover:text-gray-800');
                
                resumeTextMode.classList.remove('hidden');
                resumePdfMode.classList.add('hidden');
                
                // Limpar arquivo PDF se estiver selecionado
                if (resumeFileInput.files.length > 0) {
                    resumeFileInput.value = '';
                    resumeText = '';
                    fileNameDisplay.textContent = 'Nenhum arquivo selecionado';
                }
                
                // Focar no campo de texto
                setTimeout(() => {
                    resumeTextInput.focus();
                }, 100);
            }
        }

        async function handleJobExtraction() {
            const jobUrl = jobUrlInput.value.trim();
            
            if (!jobUrl) {
                showError('URL Necessária', 'Por favor, insira a URL da vaga do LinkedIn.');
                return;
            }
            
            // Validar se é uma URL do LinkedIn
            const linkedinJobPattern = /^https?:\/\/(www\.)?linkedin\.com\/jobs\/view\/\d+/;
            if (!linkedinJobPattern.test(jobUrl)) {
                showError('URL Inválida', 'Por favor, insira uma URL válida de vaga do LinkedIn (ex: https://www.linkedin.com/jobs/view/123456789).');
                return;
            }
            
            try {
                toggleExtractLoader(true);
                
                // Tentar extrair automaticamente primeiro
                const jobDescription = await extractJobFromLinkedIn(jobUrl);
                
                if (!jobDescription || jobDescription.trim().length === 0) {
                    throw new Error('Não foi possível extrair a descrição da vaga automaticamente.');
                }
                
                // Mostrar o resultado da extração automática
                extractedJobTextInput.value = jobDescription;
                extractedJobTextInput.readOnly = false; // Permitir edição
                extractedJobDescription.classList.remove('hidden');
                
                // Atualizar o campo principal (para compatibilidade com o resto do código)
                jobDescriptionInput.value = jobDescription;
                
                // Mostrar sucesso
                showContentModal(
                    "✅ Descrição Extraída com Sucesso!",
                    `## Extração automática concluída!

A descrição da vaga foi extraída automaticamente do LinkedIn e já está preenchida no campo abaixo.

**Próximos passos:**
1. Revise a descrição extraída (você pode editá-la se necessário)
2. Certifique-se de que todas as informações importantes estão incluídas
3. Clique em "Gerar Currículo Otimizado" para continuar

**Dica:** A extração automática captura o texto principal da vaga, mas você pode adicionar informações extras como benefícios específicos ou requisitos que possam ter sido perdidos.`
                );
                
            } catch (error) {
                console.error('Erro na extração automática:', error);
                
                // Fallback para método manual
                showError('Extração Automática Falhou', 
                    `Não foi possível extrair automaticamente: ${error.message}\n\nVamos abrir a vaga para você copiar manualmente.`);
                
                // Abrir a URL em uma nova aba como fallback
                window.open(jobUrl, '_blank');
                
                // Mostrar o campo para colar a descrição
                extractedJobDescription.classList.remove('hidden');
                extractedJobTextInput.readOnly = false;
                extractedJobTextInput.placeholder = "Cole aqui a descrição da vaga copiada do LinkedIn...";
                extractedJobTextInput.focus();
                
                // Mostrar instruções de fallback
                setTimeout(() => {
                    showContentModal(
                        " Instruções para Cópia Manual",
                        `## A extração automática não funcionou, mas você pode copiar manualmente:

1. **Na nova aba que se abriu:**
   - Localize a seção "About the job" ou "Descrição da vaga"
   - Selecione todo o texto da descrição
   - Copie (Ctrl+C)

2. **Volte para esta aba:**
   - Cole o texto no campo "Descrição Extraída" abaixo
   - O texto será automaticamente usado para otimizar seu currículo

3. **Dica:** Inclua também:
   - Requisitos e qualificações
   - Responsabilidades da função
   - Benefícios (se relevantes)

**Por que a extração automática falhou?**
- O LinkedIn pode estar bloqueando requisições automatizadas
- A estrutura da página pode ter mudado
- Pode ser uma página que requer login

Depois de colar o texto, você pode editá-lo se necessário antes de gerar o currículo otimizado.`
                    );
                }, 1000);
                
            } finally {
                toggleExtractLoader(false);
            }
        }

        async function extractJobFromLinkedIn(url) {
            // Lista de serviços proxy para tentar
            const proxyServices = [
                { name: 'AllOrigins', url: `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, type: 'json' },
                { name: 'CORS Anywhere', url: `https://cors-anywhere.herokuapp.com/${url}`, type: 'text' },
                { name: 'CodeTabs', url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, type: 'text' }
            ];
            
            let lastError = null;
            
            for (let i = 0; i < proxyServices.length; i++) {
                const proxy = proxyServices[i];
                try {
                    toggleExtractLoader(true, `Tentando ${proxy.name}...`);
                    console.log(`Tentando proxy ${i + 1} (${proxy.name}):`, proxy.url);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 segundos
                    
                    const response = await fetch(proxy.url, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                            'Accept-Language': 'en-US,en;q=0.9,pt;q=0.8'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                    }
                    
                    toggleExtractLoader(true, `Processando conteúdo...`);
                    
                    let htmlContent;
                    
                    if (proxy.type === 'json') {
                        const data = await response.json();
                        htmlContent = data.contents;
                    } else {
                        htmlContent = await response.text();
                    }
                    
                    if (!htmlContent || htmlContent.length < 1000) {
                        throw new Error('Conteúdo HTML insuficiente ou vazio');
                    }
                    
                    // Criar um parser DOM temporário
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    
                    // Tentar diferentes seletores para encontrar a descrição da vaga
                    const selectors = [
                        '.description__text',
                        '.show-more-less-html__markup',
                        '.jobs-description__content',
                        '.jobs-box__html-content',
                        '[data-test="job-description"]',
                        '.jobs-description-content__text',
                        '.jobs-description',
                        '.job-description',
                        '.description',
                        '.jobs-description-details',
                        '.jobs-box__html-content > *',
                        '.core-section-container__content',
                        '.jobs-unified-description',
                        '.jobs-description-content'
                    ];
                    
                    let jobDescription = '';
                    
                    for (const selector of selectors) {
                        const element = doc.querySelector(selector);
                        if (element) {
                            // Limpar HTML e extrair texto
                            const textContent = element.textContent || element.innerText;
                            jobDescription = cleanJobDescription(textContent);
                            
                            if (jobDescription.length > 200) { // Validar se tem conteúdo significativo
                                console.log(`Descrição encontrada usando seletor: ${selector} (proxy ${proxy.name})`);
                                console.log(`Tamanho da descrição: ${jobDescription.length} caracteres`);
                                break;
                            }
                        }
                    }
                    
                    // Se não encontrou com seletores específicos, tentar buscar por texto
                    if (!jobDescription || jobDescription.length < 200) {
                        console.log('Tentando extração por padrões de texto...');
                        jobDescription = extractJobDescriptionFromText(htmlContent);
                    }
                    
                    // Validação final
                    if (jobDescription && jobDescription.length >= 100) {
                        console.log(`Extração bem-sucedida com ${proxy.name}! Tamanho: ${jobDescription.length} caracteres`);
                        return jobDescription;
                    } else {
                        throw new Error(`Descrição muito curta ou vazia (${jobDescription.length} caracteres)`);
                    }
                    
                } catch (error) {
                    console.error(`Proxy ${proxy.name} falhou:`, error.message);
                    lastError = error;
                    
                    // Se não é o último proxy, continuar tentando
                    if (i < proxyServices.length - 1) {
                        console.log(`Tentando próximo proxy...`);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Aguardar 1 segundo
                        continue;
                    }
                }
            }
            
            // Se chegou aqui, todos os proxies falharam
            throw new Error(`Todos os métodos de extração falharam. Último erro: ${lastError?.message || 'Desconhecido'}`);
        }
        
        function cleanJobDescription(text) {
            if (!text) return '';
            
            let cleaned = text
                // Remover múltiplos espaços em branco e quebras de linha
                .replace(/\s+/g, ' ')
                // Remover caracteres de controle
                .replace(/[\x00-\x1F\x7F]/g, '')
                // Manter caracteres básicos de pontuação e texto
                .replace(/[^\w\s\-.,;:()\[\]\/&%@#$*+=<>?!'"°]/g, ' ')
                // Remover textos comuns do LinkedIn que não são da descrição
                .replace(/Show more|Show less|See more|See less|LinkedIn/gi, '')
                .replace(/Apply now|Easy Apply|Be among the first.*?applicants/gi, '')
                .replace(/Posted.*?ago|.*?applicants|.*?viewers/gi, '')
                .replace(/Save|Report this job|Flag as inappropriate/gi, '')
                .replace(/Skip to main content|Skip navigation/gi, '')
                // Remover elementos de navegação comuns
                .replace(/Main content starts here, tab to start navigating/gi, '')
                .replace(/Search jobs|Job search|Filter jobs/gi, '')
                // Limpar início e fim de frases comuns
                .replace(/^(About this job|Job description|Description|Job Details)/gi, '')
                .replace(/(Apply for this job|Submit application)$/gi, '')
                // Remover múltiplos espaços novamente
                .replace(/\s+/g, ' ')
                // Trim final
                .trim();
                
            // Se o texto ainda está muito curto ou parece inválido
            if (cleaned.length < 50 || cleaned.match(/^[^a-zA-Z]*$/)) {
                return '';
            }
            
            // Verificar se o texto parece ser uma descrição válida (contém algumas palavras-chave)
            const hasJobKeywords = /\b(experience|skills|responsibility|qualifications|requirements|role|position|job|work|team|company|candidate|application|degree|years|knowledge|ability)\b/i.test(cleaned);
            
            if (!hasJobKeywords && cleaned.length < 200) {
                return '';
            }
            
            return cleaned;
        }
        
        function extractJobDescriptionFromText(html) {
            console.log('Iniciando extração de texto simples...');
            try {
                // Remover tags HTML de forma simples
                let text = html;
                
                // Remover elementos não desejados
                text = text.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '');
                text = text.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');
                text = text.replace(/<nav[^>]*>[\s\S]*?<\/nav>/gi, '');
                text = text.replace(/<header[^>]*>[\s\S]*?<\/header>/gi, '');
                text = text.replace(/<footer[^>]*>[\s\S]*?<\/footer>/gi, '');
                
                // Remover todas as tags HTML
                text = text.replace(/</g, ' ');
                text = text.replace(/>/g, ' ');
                
                // Normalizar espaços
                text = text.replace(/\s+/g, ' ').trim();
                
                // Procurar por descrições usando indexOf
                const jobKeywords = ['about the job', 'job description', 'responsibilities', 'what you will do'];
                const endKeywords = ['qualifications', 'requirements', 'apply now', 'skills'];
                
                let bestDescription = '';
                
                for (let i = 0; i < jobKeywords.length; i++) {
                    const keyword = jobKeywords[i];
                    const startPos = text.toLowerCase().indexOf(keyword);
                    
                    if (startPos >= 0) {
                        let endPos = text.length;
                        
                        for (let j = 0; j < endKeywords.length; j++) {
                            const endKeyword = endKeywords[j];
                            const foundEnd = text.toLowerCase().indexOf(endKeyword, startPos + keyword.length);
                            if (foundEnd >= 0 && foundEnd < endPos) {
                                endPos = foundEnd;
                            }
                        }
                        
                        const description = text.substring(startPos + keyword.length, endPos);
                        const cleaned = cleanJobDescription(description);
                        
                        if (cleaned.length > bestDescription.length && cleaned.length > 100) {
                            bestDescription = cleaned;
                        }
                    }
                }
                
                if (bestDescription) {
                    console.log('Descrição encontrada com sucesso');
                    return bestDescription;
                }
                
                return '';
                
            } catch (error) {
                console.error('Erro na extração:', error);
                return '';
            }
        }

        function toggleExtractLoader(isLoading, status = '') {
            extractJobButton.disabled = isLoading;
            extractLoader.classList.toggle('hidden', !isLoading);
            
            if (isLoading) {
                extractButtonText.textContent = status || 'Extraindo...';
            } else {
                extractButtonText.textContent = 'Extrair Descrição';
            }
        }

        function updateLanguageSelection() {
            const selectedLanguage = document.querySelector('input[name="resumeLanguage"]:checked').value;
            console.log('Selected language:', selectedLanguage);
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            
            if (!file) {
                fileNameDisplay.textContent = 'Nenhum arquivo selecionado';
                resumeText = '';
                return;
            }
            
            const validation = validateFileInput(file);
            if (!validation.valid) {
                fileNameDisplay.textContent = validation.error;
                fileNameDisplay.classList.add('text-red-500');
                resumeText = '';
                return;
            }
            
            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.remove('text-red-500');
            
            try {
                resumeText = await extractTextFromPdf(file);
                if (!resumeText || resumeText.trim().length === 0) {
                    throw new Error('Não foi possível extrair texto do PDF');
                }
            } catch (err) {
                showError('Erro no PDF', 'Não foi possível ler o conteúdo do arquivo PDF: ' + err.message);
                resumeText = '';
                fileNameDisplay.textContent = 'Erro ao processar o arquivo';
                fileNameDisplay.classList.add('text-red-500');
            }
        }

        async function extractTextFromPdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ');
            }
            return fullText;
        }

        function handleTextInput(event) {
            const textValue = event.target.value.trim();
            
            if (textValue) {
                // Atualizar a variável global com o texto do currículo
                resumeText = textValue;
                console.log('Texto do currículo atualizado:', textValue.substring(0, 100) + '...');
            } else {
                // Limpar se vazio
                resumeText = '';
            }
        }

        async function handleResumeGeneration() {
            try {
                checkRateLimit();
                
                // Garantir que resumeText está atualizado se o modo texto estiver ativo
                if (!resumeTextMode.classList.contains('hidden')) {
                    resumeText = resumeTextInput.value.trim();
                }
                
                toggleMainLoader(true);
                const prompt = getPrompt('optimize');
                const result = await callGeminiAPI(prompt);
                optimizedMarkdown = result;
                
                // Debug: Log do resultado da API
                console.log('Markdown bruto recebido:', optimizedMarkdown.substring(0, 500) + '...');
                
                // Processar markdown usando a função robusta
                const htmlContent = processMarkdown(optimizedMarkdown);
                
                // Debug: Log do HTML gerado
                console.log('HTML gerado:', htmlContent.substring(0, 500) + '...');
                
                markdownPreview.innerHTML = DOMPurify.sanitize(htmlContent);
                
                // Forçar re-renderização dos estilos
                markdownPreview.classList.remove('prose-output');
                setTimeout(() => {
                    markdownPreview.classList.add('prose-output');
                }, 10);
                
                downloadPdfButton.disabled = false;
                enableFeatureButtons(true);
            } catch (error) {
                console.error('Erro na geração:', error);
                showError('Erro na Otimização', error.message);
                markdownPreview.innerHTML = DOMPurify.sanitize(`<p class="text-red-500">Falha ao gerar o currículo. Verifique sua chave de API e os dados fornecidos.</p>`);
                downloadPdfButton.disabled = true;
                enableFeatureButtons(false);
            } finally {
                toggleMainLoader(false);
            }
        }

        async function handleFeatureClick(button, feature) {
            if (button.disabled) return;
            try {
                checkRateLimit();
                
                // Garantir que resumeText está atualizado se o modo texto estiver ativo
                if (!resumeTextMode.classList.contains('hidden')) {
                    resumeText = resumeTextInput.value.trim();
                }
                
                toggleFeatureLoader(button, true);
                const prompt = getPrompt(feature, optimizedMarkdown);
                const result = await callGeminiAPI(prompt);
                const titles = {
                    atsScore: "Score de Aderência ATS",
                    analyze: "Análise Completa de Currículo",
                    questions: "Sugestões para Entrevista",
                    coverLetter: "Rascunho da Carta de Apresentação",
                    linkedin: "Otimização para Perfil do LinkedIn",
                    followup: "Rascunho de E-mail de Agradecimento",
                    pitch: "Gerador de Pitch Pessoal",
                    star: "Construtor de Histórias (Método STAR)",
                    summary: "Resumo de Qualificações Focado na Vaga",
                    salary: "Análise Salarial: CLT vs PJ"
                };
                showContentModal(titles[feature], result);
            } catch (error) {
                showError(`Erro na feature: ${feature}`, error.message);
            } finally {
                toggleFeatureLoader(button, false);
            }
        }

        async function callGeminiAPI(prompt) {
            const apiKey = apiKeyInput.value.trim();
            
            // Obter descrição da vaga do campo ativo
            let jobDescription;
            if (jobUrlMode.classList.contains('hidden')) {
                // Modo texto ativo
                jobDescription = jobDescriptionInput.value.trim();
            } else {
                // Modo URL ativo - usar texto extraído ou o campo principal
                jobDescription = extractedJobTextInput.value.trim() || jobDescriptionInput.value.trim();
            }

            if (!apiKey || !jobDescription || !resumeText) {
                let missing = [];
                if (!apiKey) missing.push("Chave de API");
                if (!jobDescription) missing.push("Descrição da Vaga");
                if (!resumeText) missing.push("Currículo (PDF ou Texto)");
                throw new Error(`Dados Incompletos. Por favor, preencha: ${missing.join(', ')}.`);
            }
            
            // Validar formato da chave de API
            if (!validateApiKey(apiKey)) {
                throw new Error('Chave de API inválida. Verifique se a chave está no formato correto.');
            }

            // Limitar tamanho do prompt para evitar ataques DoS
            if (prompt.length > 100000) {
                throw new Error('Prompt muito longo. Reduza o conteúdo e tente novamente.');
            }

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            // Sistema de retry com backoff exponencial
            const maxRetries = 3;
            let attempt = 0;
            
            while (attempt < maxRetries) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 45000); // Timeout maior para retries

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'User-Agent': 'Resume-Optimizer/1.0'
                        },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.message || `Erro na API: ${response.status} ${response.statusText}`;
                        
                        // Verificar se é erro de sobrecarga (retryable)
                        const isOverloadError = errorMessage.toLowerCase().includes('overloaded') || 
                                              errorMessage.toLowerCase().includes('quota') ||
                                              errorMessage.toLowerCase().includes('rate limit') ||
                                              response.status === 429 || response.status === 503;
                        
                        if (isOverloadError && attempt < maxRetries - 1) {
                            attempt++;
                            const waitTime = Math.pow(2, attempt) * 1000 + Math.random() * 1000; // Backoff exponencial com jitter
                            console.log(`Tentativa ${attempt}/${maxRetries} falhou. Aguardando ${Math.round(waitTime/1000)}s...`);
                            
                            // Mostrar progresso ao usuário
                            if (typeof showTemporaryMessage === 'function') {
                                showTemporaryMessage(` API ocupada. Tentativa ${attempt}/${maxRetries}... Aguardando ${Math.round(waitTime/1000)}s`);
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                            continue;
                        }
                        
                        // Melhorar mensagem para usuário final
                        if (isOverloadError) {
                            throw new Error(' A API do Google está muito ocupada no momento. Aguarde alguns minutos e tente novamente. Este erro é temporário e comum em horários de pico.');
                        }
                        
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                        const responseText = result.candidates[0].content.parts[0].text;
                        
                        // Validação básica da resposta
                        if (responseText.length > 200000) {
                            throw new Error('Resposta da API muito longa. Tente novamente.');
                        }
                        
                        return responseText;
                    } else {
                        throw new Error("A API não retornou uma resposta válida. A resposta pode estar bloqueada por políticas de segurança.");
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        if (attempt < maxRetries - 1) {
                            attempt++;
                            console.log(`Timeout na tentativa ${attempt}/${maxRetries}. Tentando novamente...`);
                            
                            // Mostrar progresso ao usuário
                            if (typeof showTemporaryMessage === 'function') {
                                showTemporaryMessage(`⏱ Timeout. Tentativa ${attempt}/${maxRetries}...`);
                            }
                            
                            continue;
                        }
                        throw new Error('⏱ Timeout na conexão. A API está respondendo lentamente. Tente novamente em alguns minutos.');
                    }
                    
                    // Se não for um erro retryable, lançar imediatamente
                    if (!error.message.includes('overloaded') && !error.message.includes('quota') && !error.message.includes('rate limit')) {
                        throw error;
                    }
                    
                    // Se chegou ao limite de tentativas
                    if (attempt >= maxRetries - 1) {
                        throw error;
                    }
                    
                    attempt++;
                    const waitTime = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    console.log(`Erro na tentativa ${attempt}/${maxRetries}. Aguardando ${Math.round(waitTime/1000)}s...`);
                    
                    // Mostrar progresso ao usuário
                    if (typeof showTemporaryMessage === 'function') {
                        showTemporaryMessage(` Erro temporário. Tentativa ${attempt}/${maxRetries}... Aguardando ${Math.round(waitTime/1000)}s`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
                }
                    async function downloadAsPdf() {
            if (!optimizedMarkdown) {
                showError('Nenhum Conteudo', 'Nao ha curriculo gerado para baixar.');
                return;
            }

            let fileName = pdfFileNameInput.value.trim();
            if (!fileName) {
                fileName = generateFileNameFromJobDescription();
            }

            if (!fileName.toLowerCase().endsWith('.pdf')) {
                fileName += '.pdf';
            }

            const popup = window.open('', '_blank');
            if (!popup) {
                showError('Popup bloqueado', 'Permita popups para baixar o PDF.');
                return;
            }

            const printableHtml = DOMPurify.sanitize(processMarkdown(optimizedMarkdown));
            const safeTitle = fileName.replace(/[\n\r\t\f\v]+/g, '_');

            const template = `<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${safeTitle}</title>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      margin: 32px;
      color: #1f2937;
      line-height: 1.6;
      background: #ffffff;
    }
    h1, h2, h3, h4 {
      color: #111827;
      margin-top: 24px;
      margin-bottom: 12px;
    }
    h1 { font-size: 26px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
    h2 { font-size: 22px; }
    h3 { font-size: 18px; }
    h4 { font-size: 16px; }
    p { margin-bottom: 12px; }
    ul { padding-left: 24px; margin-bottom: 12px; }
    li { margin-bottom: 6px; }
    strong { color: #111827; }
    em { color: #4b5563; }
    hr { border: none; height: 2px; background: linear-gradient(to right, #cbd5f5, #e5e7eb, #cbd5f5); margin: 24px 0; }
    .container { max-width: 800px; margin: 0 auto; }
    .print-actions { margin-top: 24px; }
    .btn-print {
      padding: 10px 16px;
      background: #4f46e5;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-print:hover { background: #4338ca; }
    @media print {
      .print-actions { display: none; }
      body { margin: 24px; }
    }
  </style>
</head>
<body>
  <div class="container">${printableHtml}</div>
  <div class="print-actions">
    <button id="printTrigger" class="btn-print">Imprimir / Salvar PDF</button>
  </div>
</body>
</html>`;

            popup.document.open();
            popup.document.write(template);
            popup.document.close();
            popup.document.title = safeTitle;

            const triggerPrint = () => {
                if (popup.closed) return;
                popup.focus();
                try { popup.print(); } catch (err) { console.error(err); }
            };

            const wirePrint = () => {
                if (popup.closed) return;
                const button = popup.document.getElementById('printTrigger');
                if (button) {
                    button.addEventListener('click', triggerPrint);
                }
                triggerPrint();
            };

            if (popup.document.readyState === 'complete') {
                setTimeout(wirePrint, 0);
            } else {
                popup.addEventListener('load', () => setTimeout(wirePrint, 0), { once: true });
            }
        }


        /**
         * Selects and builds the correct prompt for the desired feature.
         * Added new prompts for 'pitch' and 'star'.
         * User inputs are now sanitized.
         */
        function getPrompt(type, markdownInput = '') {
            // Obter descrição da vaga do campo ativo
            let jobDescValue;
            if (jobUrlMode.classList.contains('hidden')) {
                // Modo texto ativo
                jobDescValue = jobDescriptionInput.value;
            } else {
                // Modo URL ativo - usar texto extraído ou o campo principal
                jobDescValue = extractedJobTextInput.value || jobDescriptionInput.value;
            }
            
            const jobDesc = sanitizeForPrompt(jobDescValue);
            const originalResume = sanitizeForPrompt(resumeText);
            const markdown = sanitizeForPrompt(markdownInput); // Sanitize the markdown input from optimized resume
            const selectedLanguage = document.querySelector('input[name="resumeLanguage"]:checked').value;
            
            // Language-specific instructions
            const languageInstructions = {
                'pt-br': 'Responda em português brasileiro. Use formatação e terminologia adequadas ao mercado de trabalho brasileiro.',
                'en': 'Respond in English. Use professional formatting and terminology appropriate for the international job market.'
            };
            
            const langInstruction = languageInstructions[selectedLanguage];

            const baseOptimizePrompt = `[Persona] Aja como um Estrategista de Carreira e Redator de Currículos especialista em otimização para ATS. [Contexto] Reescreva o currículo para maximizar a compatibilidade com a vaga. [Entradas] \nDescrição da Vaga: \n\`\`\`${jobDesc}\`\`\`\n\nTexto do Currículo Atual:\n\`\`\`${originalResume}\`\`\`\n\n[Instruções] Analise a vaga, identifique palavras-chave, e reescreva o currículo seção por seção. ${langInstruction} [Formato da Saída] Produza o currículo final em formato Markdown limpo e de coluna única. Use --- para separar seções. [Restrição CRÍTICA] O resultado DEVE começar diretamente com o conteúdo do currículo. NÃO inclua nenhuma frase introdutória ou comentário.`;

            switch (type) {
                case 'optimize':
                    return baseOptimizePrompt;
                case 'atsScore':
                    return `[Persona] Especialista em ATS (Applicant Tracking Systems). [Contexto] Calcular score de aderência entre currículo e vaga. [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurrículo Original:\n\`\`\`${originalResume}\`\`\`\n\nCurrículo Otimizado:\n\`\`\`${markdown}\`\`\`\n\n[Instruções] Compare os currículos e calcule:\n\n##  Score ATS\n\n### Currículo Original: [X]%\n- Palavras-chave encontradas: X/Y\n- Habilidades técnicas: X/Y\n- Experiência relevante: X/Y\n\n### Currículo Otimizado: [Z]%\n- Palavras-chave encontradas: X/Y\n- Habilidades técnicas: X/Y\n- Experiência relevante: X/Y\n\n###  Melhoria: +[diferença]%\n\n## Detalhamento\n\n### ✅ Palavras-chave Identificadas\n[Lista das principais palavras-chave da vaga encontradas]\n\n### ⚠ Palavras-chave Ausentes\n[Lista das palavras-chave importantes que ainda faltam]\n\n###  Recomendações\n[3-5 sugestões específicas para melhorar ainda mais o score]\n\n${langInstruction} [Formato da Saída] Markdown.`;
                case 'analyze':
                    return `[Persona] Coach de Carreira sênior e analista. [Contexto] Análise completa do currículo otimizado. [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurrículo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instruções] Forneça análise detalhada em 4 seções:\n\n##  Pontos Fortes\n[Destaque os elementos mais alinhados com a vaga]\n\n##  Pontos a Melhorar\n[Sugestões construtivas e específicas]\n\n##  Diferenciais Competitivos\n[O que torna este perfil único para a vaga]\n\n##  Próximos Passos\n[Ações concretas para fortalecer a candidatura]\n\n${langInstruction} [Formato da Saída] Markdown com cabeçalhos.`;
                case 'questions':
                    return `[Persona] Gerente de Contratação experiente. [Contexto] Preparar para entrevista. [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurrículo do Candidato (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instruções] Crie duas listas: "Perguntas que o Entrevistador Pode Fazer" e "Perguntas Inteligentes para Você Fazer". ${langInstruction} [Formato da Saída] Markdown com cabeçalhos.`;
                case 'coverLetter':
                    return `[Persona] Redator Profissional. [Contexto] Escrever uma carta de apresentação. [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurrículo do Candidato (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instruções] Escreva um rascunho de carta de apresentação profissional de 3 parágrafos. ${langInstruction} [Formato da Saída] Markdown.`;
                case 'linkedin':
                    return `[Persona] Especialista em Marca Pessoal e LinkedIn. [Contexto] Otimizar um perfil do LinkedIn. [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurrículo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instruções] Gere 3 seções: 'Título Profissional (Headline)', 'Seção "Sobre"', e 'Principais Competências'. ${langInstruction} [Formato da Saída] Markdown com cabeçalhos.`;
                case 'followup':
                    return `[Persona] Coach de Carreira. [Contexto] Escrever e-mail de agradecimento pós-entrevista. [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\n[Instruções] Crie um rascunho de e-mail de agradecimento. Use placeholders como '[Nome do Entrevistador]' e '[Seu Nome]'. O e-mail deve ter assunto claro, agradecer, reiterar interesse, e mencionar um ponto positivo da conversa. ${langInstruction} [Formato da Saída] Texto formatado como e-mail.`;
                case 'pitch':
                    return `[Persona] Coach de Carreira especialista em entrevistas. [Contexto] Criar um "pitch" para a pergunta "Fale sobre você". [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurrículo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instruções] Crie um pitch pessoal de 3 parágrafos (máximo de 150 palavras). 1º parágrafo: Apresentação (profissão, anos de experiência). 2º parágrafo: Conecte suas habilidades e uma conquista chave do currículo aos requisitos da vaga. 3º parágrafo: Expresse entusiasmo pela vaga e o que espera alcançar. ${langInstruction} [Formato da Saída] Markdown.`;                case 'star':
                    return `[Persona] Coach de Entrevistas Comportamentais. [Contexto] Estruturar experiências usando o método STAR (Situação, Tarefa, Ação, Resultado). [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurrículo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instruções] Selecione as 2 experiências profissionais mais relevantes do currículo. Para cada uma, estruture-a no formato STAR: **Situação:** (O contexto/desafio), **Tarefa:** (Sua responsabilidade), **Ação:** (O que você fez), **Resultado:** (O impacto quantificado). ${langInstruction} [Formato da Saída] Markdown com cabeçalhos claros para cada história e para S, T, A, R.`;                case 'salary':
                    return `[Persona] Consultor de Remuneração especialista no mercado brasileiro. [Contexto] Calcular pretensão salarial para CLT e PJ de forma prática e objetiva. [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurrículo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instruções] Forneça uma análise concisa e prática seguindo exatamente esta estrutura:

##  ANÁLISE DA VAGA
- **Nível:** (Júnior/Pleno/Sênior/Especialista)
- **Setor:** (identifique o setor)
- **Localização:** (infira: SP/RJ/Remoto/Nacional)
- **Porte da empresa:** (Startup/Média/Grande)

##  SEU PERFIL
- **Experiência relevante:** X anos
- **Match com a vaga:** (Alto/Médio/Baixo) - justifique brevemente
- **Diferencial:** (principal ponto forte para esta vaga)

##  VALORES SUGERIDOS

### CLT
- **Salário bruto:** R$ X.XXX a R$ X.XXX
- **Com benefícios típicos:** ~R$ X.XXX (VR + Plano + outros)
- **Custo total empresa:** ~R$ X.XXX (para sua referência)

### PJ
- **Valor/hora:** R$ XXX (160h/mês)
- **Faturamento mensal:** R$ X.XXX
- **Líquido estimado:** ~R$ X.XXX (descontando impostos simples)

##  RECOMENDAÇÃO
**Modalidade mais vantajosa:** [CLT/PJ/Equivalente]
**Justificativa:** (1-2 frases explicando o porquê)

##  COMO NEGOCIAR
### Se perguntarem sua pretensão:
- **CLT:** "Estou buscando algo entre R$ X.XXX e R$ X.XXX, dependendo do pacote de benefícios"
- **PJ:** "Meu valor/hora é R$ XXX, que dá aproximadamente R$ X.XXX mensais"

### Dicas rápidas:
- Sempre dê uma faixa, nunca um valor fixo
- Pesquise no Glassdoor/Vagas.com antes de negociar
- Considere benefícios como parte da negociação

${langInstruction} [FORMATO OBRIGATÓRIO] Markdown exatamente como estruturado acima. Seja direto, use valores realistas do mercado brasileiro atual.`;
                case 'summary':
                    return `[Persona] Redator Profissional especialista em currículos. [Contexto] Criar um resumo executivo de qualificações focado especificamente na vaga. [Entradas]\nDescrição da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurrículo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instruções] Crie um resumo executivo de 3-4 frases que destaque as qualificações mais relevantes do candidato para esta vaga específica. O resumo deve: 1) Mencionar anos de experiência na área relevante; 2) Destacar as 2-3 competências técnicas mais alinhadas com a vaga; 3) Incluir uma conquista quantificada que demonstre impacto; 4) Conectar diretamente o perfil aos requisitos da vaga. ${langInstruction} [Formato da Saída] Parágrafo único em Markdown, conciso e impactante, ideal para usar no topo do currículo.`;
                default:
                    return '';
            }
        }


        function toTitleCase(text) {
            if (!text) return '';
            const lower = text.toLowerCase();
            const smallWords = new Set(['de', 'da', 'do', 'das', 'dos', 'e']);
            return lower
                .split(' ')
                .filter(Boolean)
                .map((word, index) => {
                    if (smallWords.has(word) && index !== 0) {
                        return word;
                    }
                    return word.charAt(0).toUpperCase() + word.slice(1);
                })
                .join(' ');
        }

        function sanitizeFileNameBase(name) {
            return name
                .replace(/[<>:"/\\|?*]+/g, '')
                .replace(/\s+/g, ' ')
                .trim()
                .substring(0, 120);
        }

        function normalizeSegment(segment) {
            if (!segment) return '';
            return toTitleCase(
                segment
                    .replace(/[\u2010-\u2015]/g, '-')
                    .replace(/\s+/g, ' ')
                    .replace(/\s*[-–—]\s*$/g, '')
                    .replace(/\s*\(.*\)$/, '')
                    .replace(/\s*\d+$/, '')
                    .trim()
            );
        }

        function buildHumanReadableName(jobDesc) {
            const lines = jobDesc
                .split(/\r?\n/)
                .map(line => line.trim())
                .filter(Boolean);

            const candidateLine = lines.find(line => /[-–—]/.test(line)) || lines[0];

            if (candidateLine) {
                const match = candidateLine.match(/^(.+?)\s*[-–—]\s*(.+)$/);
                if (match) {
                    const role = normalizeSegment(match[1]);
                    const company = normalizeSegment(match[2]);

                    if (role && company) {
                        const baseName = `${role} - ${company}`;
                        return sanitizeFileNameBase(baseName);
                    }
                }
            }

            return '';
        }

        function generateFileNameFromJobDescription() {
            // Obter descrição da vaga do campo ativo
            let jobDesc;
            if (jobUrlMode.classList.contains('hidden')) {
                // Modo texto ativo
                jobDesc = jobDescriptionInput.value.trim();
            } else {
                // Modo URL ativo - usar texto extraído ou o campo principal
                jobDesc = extractedJobTextInput.value.trim() || jobDescriptionInput.value.trim();
            }
            
            if (!jobDesc) {
                return 'curriculo-otimizado';
            }

            const humanReadable = buildHumanReadableName(jobDesc);
            if (humanReadable) {
                return humanReadable;
            }

            let fileName = jobDesc
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+\d+$/g, '')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 100);

            const jobTitlePatterns = [
                /vaga\s+(?:de|para)\s+([^.,:;]+)/i,
                /contrata[çc]ão\s+(?:de|para)\s+([^.,:;]+)/i,
                /busca(?:mos)?\s+([^.,:;]+)/i,
                /desenvolvedor[a]?\s+([\w\s]+)/i,
                /analista\s+([\w\s]+)/i,
                /gerente\s+([\w\s]+)/i,
                /coordenador[a]?\s+([\w\s]+)/i,
                /especialista\s+([\w\s]+)/i,
                /consultor[a]?\s+([\w\s]+)/i,
                /engenheiro[a]?\s+([\w\s]+)/i
            ];

            for (const pattern of jobTitlePatterns) {
                const match = jobDesc.match(pattern);
                if (match && match[1]) {
                    const extractedTitle = match[1]
                        .trim()
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+\d+$/g, '')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '')
                        .substring(0, 50);

                    if (extractedTitle.length > 3) {
                        return `curriculo-${extractedTitle}`;
                    }
                }
            }

            const words = fileName.split('-').filter(word => word.length > 2).slice(0, 5);
            const fallback = words.length > 0 ? `curriculo-${words.join('-')}` : 'curriculo-otimizado';
            return fallback;
        }

        function sanitizeForPrompt(text) {
            if (typeof text !== 'string') return '';
            // Escape backticks and other potentially dangerous characters
            return text
                .replace(/`/g, '\\`')
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // Remove script tags
                .replace(/javascript:/gi, '') // Remove javascript: protocol
                .replace(/on\w+\s*=/gi, '') // Remove event handlers
                .substring(0, 50000); // Limit length to prevent DoS
        }

        // Função para validar chave de API
        function validateApiKey(apiKey) {
            if (!apiKey || typeof apiKey !== 'string') return false;
            // Validação básica do formato da chave de API do Google AI Studio
            const apiKeyPattern = /^[A-Za-z0-9_-]{39}$/;
            return apiKeyPattern.test(apiKey.trim());
        }

        // Função para sanitizar entrada de arquivo
        function validateFileInput(file) {
            if (!file) return { valid: false, error: 'Nenhum arquivo selecionado' };
            
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
            const ALLOWED_TYPES = ['application/pdf'];
            
            if (!ALLOWED_TYPES.includes(file.type)) {
                return { valid: false, error: 'Tipo de arquivo não permitido. Apenas PDF é aceito.' };
            }
            
            if (file.size > MAX_FILE_SIZE) {
                return { valid: false, error: 'Arquivo muito grande. Máximo 10MB.' };
            }
            
            return { valid: true };
        }

        // --- UI Helper Functions ---

        function toggleMainLoader(isLoading) {
            generateButton.disabled = isLoading;
            loader.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Gerando...' : 'Gerar Currículo Otimizado';
        }

        function toggleFeatureLoader(button, isLoading) {
            button.disabled = isLoading;
            if (isLoading) {
                const icon = button.querySelector('.feature-icon').textContent;
                button.innerHTML = DOMPurify.sanitize(`
                    <div class="feature-icon mb-2 animate-pulse">
                        <div class="feature-loader mx-auto"></div>
                    </div>
                    <span class="font-semibold text-xs">Processando...</span>
                `);
            } else {
                button.innerHTML = DOMPurify.sanitize(button.getAttribute('data-original-text'));
            }
        }

        function enableFeatureButtons(isEnabled) {
            Object.keys(featureButtons).forEach(key => {
                const btn = featureButtons[key];
                btn.disabled = !isEnabled;

                // Remove all style classes first
                btn.className = btn.className.replace(/bg-gradient-to-br[^\s]*|from-[^\s]*|to-[^\s]*|text-[^\s]*|hover:[^\s]*|border-[^\s]*|transform[^\s]*|scale-[^\s]*|shadow-[^\s]*|opacity-[^\s]*|cursor-[^\s]*/g, '').replace(/\s+/g, ' ').trim();
                
                // Preserve layout classes
                let layoutClasses = '';
                if (btn.className.includes('md:col-span-2')) layoutClasses += ' md:col-span-2';
                if (btn.className.includes('lg:col-span-3')) layoutClasses += ' lg:col-span-3';
                
                // Apply base classes and state-specific styles
                btn.className = `${baseBtnClasses}${layoutClasses} ${isEnabled ? enabledBtnClasses : disabledBtnClasses}`;

                if(isEnabled && !btn.hasAttribute('data-original-text')) {
                    btn.setAttribute('data-original-text', btn.innerHTML);
                    // Add click effect only once
                    if (!btn.hasEventListeners) {
                        btn.addEventListener('mouseenter', function() {
                            if (!this.disabled) {
                                this.style.transform = 'translateY(-2px) scale(1.02)';
                            }
                        });
                        btn.addEventListener('mouseleave', function() {
                            if (!this.disabled) {
                                this.style.transform = 'translateY(0) scale(1)';
                            }
                        });
                        btn.hasEventListeners = true;
                    }
                }
            });
        }

        function showError(title, message) {
            errorModalTitle.textContent = title;
            errorModalMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }

        function showTemporaryMessage(message, duration = 3000) {
            // Remover mensagem anterior se existir
            const existing = document.getElementById('temp-message');
            if (existing) existing.remove();
            
            // Criar nova mensagem temporária
            const tempDiv = document.createElement('div');
            tempDiv.id = 'temp-message';
            tempDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm font-medium animate-pulse';
            tempDiv.textContent = message;
            
            document.body.appendChild(tempDiv);
            
            // Remover automaticamente após o tempo especificado
            setTimeout(() => {
                if (tempDiv.parentNode) {
                    tempDiv.remove();
                }
            }, duration);
        }

        function showContentModal(title, markdownContent) {
            contentModalTitle.textContent = title;
            
            // Processar markdown usando a função robusta
            const htmlContent = processMarkdown(markdownContent);
            contentModalBody.innerHTML = DOMPurify.sanitize(htmlContent);
            
            contentModal.classList.remove('hidden');
        }

        async function validateLinkedInUrl(url) {
            try {
                // Verificar se a URL responde (mesmo que seja bloqueada pelo CORS)
                const response = await fetch(url, { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                return true; // Se chegou até aqui, a URL existe
            } catch (error) {
                // Mesmo com erro de CORS, se for um erro de rede, a URL pode não existir
                if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
                    return false;
                }
                return true; // Outros erros (como CORS) indicam que a URL existe
            }
        }
    </script>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "teiwdomoe7");
</script>
</body>
</html>
