<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÑ</text></svg>">
    <!-- CSP mais permissivo para desenvolvimento, mas ainda seguro -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; connect-src 'self' https://generativelanguage.googleapis.com; img-src 'self' data: blob:; worker-src 'self' blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:;">
    <title>Otimizador de Curr√≠culo com IA v7</title>
    <!-- Tailwind CSS - Vers√£o CDN que funciona localmente -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- pdf.js and jspdf for PDF handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <!-- marked.js for Markdown to HTML conversion -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Suprimir avisos de propriedades espec√≠ficas do navegador */
        html {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%; 
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Styles for generated content */
        .prose-output {
            line-height: 1.6;
            color: #2d3748;
        }
        
        .prose-output h1, .prose-output h2, .prose-output h3, .prose-output h4 { 
            font-weight: bold; 
            margin-top: 1.5rem; 
            margin-bottom: 0.75rem; 
            color: #1a202c;
        }
        .prose-output h1 { 
            font-size: 1.875rem; 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 0.5rem;
        }
        .prose-output h2 { 
            font-size: 1.5rem; 
            color: #2d3748;
        }
        .prose-output h3 { 
            font-size: 1.25rem; 
            color: #4a5568;
        }
        .prose-output h4 { 
            font-size: 1.125rem; 
            color: #4a5568; 
        }
        
        .prose-output p { 
            margin-bottom: 1rem; 
            text-align: justify;
        }
        
        .prose-output ul { 
            list-style-type: disc; 
            margin-left: 2rem; 
            margin-bottom: 1rem;
        }
        .prose-output ol { 
            list-style-type: decimal; 
            margin-left: 2rem; 
            margin-bottom: 1rem;
        }
        .prose-output li { 
            margin-bottom: 0.5rem; 
            line-height: 1.5;
        }
        
        .prose-output strong { 
            font-weight: 600; 
            color: #1a202c;
        }
        .prose-output em { 
            font-style: italic; 
            color: #4a5568;
        }
        
        .prose-output hr {
            border: none;
            height: 2px;
            background: linear-gradient(to right, #cbd5e0, #e2e8f0, #cbd5e0);
            margin: 2rem 0;
        }
        
        .prose-output blockquote {
            border-left: 4px solid #4299e1;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #4a5568;
        }
        
        .prose-output code {
            background-color: #f7fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .prose-output pre {
            background-color: #f7fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .prose-output a {
            color: #4299e1;
            text-decoration: underline;
        }
        .prose-output a:hover {
            color: #3182ce;
        }

        /* Loading spinner for feature buttons */
        .feature-loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Language selection styles */
        .language-option {
            min-width: 120px;
        }
        
        input[name="resumeLanguage"]:checked + .language-option {
            background-color: #e0e7ff;
            border-color: #4f46e5;
        }
        
        input[name="resumeLanguage"]:not(:checked) + .language-option {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        
        input[name="resumeLanguage"]:checked + .language-option span:last-child {
            color: #4338ca;
        }
        
        input[name="resumeLanguage"]:not(:checked) + .language-option span:last-child {
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Assistente de Carreira com IA</h1>
            <p class="mt-2 text-md text-gray-600">Otimize seu curr√≠culo, prepare-se para a entrevista e fortale√ßa sua presen√ßa profissional.</p>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">1. Forne√ßa os Dados</h2>

                <div class="mb-6">
                    <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">Sua Chave de API do Google AI Studio</label>
                    <input type="password" id="apiKey" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Cole sua chave de API aqui">
                    <p class="text-xs text-gray-500 mt-1"><strong>Aviso de Seguran√ßa:</strong> Sua chave de API √© usada no seu navegador e n√£o √© armazenada por este site. Considere usar chaves com escopo restrito ou revog√°-las ap√≥s o uso.</p>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-xs text-indigo-600 hover:underline mt-1 block">N√£o tem uma chave? Crie uma aqui.</a>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">Descri√ß√£o da Vaga</label>
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button id="jobInputModeText" class="px-3 py-1 text-xs font-medium rounded-md transition-colors bg-indigo-600 text-white">Texto</button>
                            <button id="jobInputModeUrl" class="px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800">URL LinkedIn</button>
                        </div>
                    </div>
                    
                    <!-- Modo Texto (padr√£o) -->
                    <div id="jobTextMode">
                        <textarea id="jobDescription" rows="8" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Cole a descri√ß√£o completa da vaga..."></textarea>
                    </div>
                    
                    <!-- Modo URL -->
                    <div id="jobUrlMode" class="hidden">
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <input type="url" id="jobUrl" class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="https://www.linkedin.com/jobs/view/...">
                                <button id="extractJobButton" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <svg id="extractLoader" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="extractButtonText">Extrair Descri√ß√£o</span>
                                </button>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                                <div class="flex items-start">
                                    <svg class="h-5 w-5 text-blue-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    <div class="text-blue-700">
                                        <strong>‚ú® Extra√ß√£o Inteligente:</strong> Cole a URL da vaga do LinkedIn e clique em "Extrair Descri√ß√£o". O sistema tentar√° extrair automaticamente o conte√∫do da vaga usando m√∫ltiplos m√©todos. Se a extra√ß√£o autom√°tica falhar, voc√™ ser√° orientado para c√≥pia manual.
                                    </div>
                                </div>
                            </div>
                            <div id="extractedJobDescription" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o Extra√≠da</label>
                                <textarea id="extractedJobText" rows="6" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="A descri√ß√£o da vaga extra√≠da aparecer√° aqui..."></textarea>
                                <p class="text-xs text-gray-500 mt-1">‚úÖ Descri√ß√£o sincronizada automaticamente. Voc√™ pode editar se necess√°rio.</p>
                            </div>
                        </div>
                    </div>
                </div>                <div class="mb-6">
                    <label for="resumeFile" class="block text-sm font-medium text-gray-700 mb-1">Seu Curr√≠culo em PDF</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                            <div class="flex text-sm text-gray-600"><label for="resumeFile" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500"><span>Anexar o curr√≠culo</span><input id="resumeFile" name="resumeFile" type="file" class="sr-only" accept=".pdf"></label><p class="pl-1">ou arraste e solte</p></div>
                            <p id="fileName" class="text-xs text-gray-500">Apenas PDF</p>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="pdfFileName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Arquivo PDF (opcional)</label>
                    <input type="text" id="pdfFileName" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Ex: curriculo-desenvolvedor-frontend">
                    <p class="text-xs text-gray-500 mt-1">Se vazio, ser√° gerado automaticamente baseado na vaga</p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Idioma do Curr√≠culo</label>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" id="languagePt" name="resumeLanguage" value="pt-br" class="sr-only" checked>
                            <div class="language-option w-full px-4 py-3 bg-indigo-100 border-2 border-indigo-500 rounded-lg text-center transition-all duration-200 hover:bg-indigo-200">
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-2xl">üáßüá∑</span>
                                    <span class="font-medium text-indigo-800">Portugu√™s</span>
                                </div>
                            </div>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" id="languageEn" name="resumeLanguage" value="en" class="sr-only">
                            <div class="language-option w-full px-4 py-3 bg-gray-100 border-2 border-gray-300 rounded-lg text-center transition-all duration-200 hover:bg-gray-200">
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-2xl">üá∫üá∏</span>
                                    <span class="font-medium text-gray-600">English</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <button id="generateButton" class="w-full mt-auto bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out flex items-center justify-center">
                    <svg id="loader" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span id="buttonText">Gerar Curr√≠culo Otimizado</span>
                </button>
            </div>

            <!-- Output Section -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">2. Resultado</h2>
                    <button id="downloadPdfButton" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Baixar PDF</button>
                </div>
                <div id="outputContainer" class="w-full h-[45vh] bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-y-auto prose-output">
                    <div id="markdown-preview"><p class="text-gray-500">Seu curr√≠culo otimizado aparecer√° aqui...</p></div>
                </div>

                <!-- AI Assistant Features -->
                <div id="aiFeatures" class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Assistente de Candidatura</h3>                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <button id="coverLetterButton" class="feature-btn" disabled>‚ú® Rascunhar Carta</button>
                        <button id="linkedinButton" class="feature-btn" disabled>‚ú® Otimizar LinkedIn</button>
                        <button id="analyzeButton" class="feature-btn" disabled>‚ú® Analisar Pontos Fortes</button>
                        <button id="questionsButton" class="feature-btn" disabled>‚ú® Gerar Perguntas</button>
                        <button id="pitchButton" class="feature-btn" disabled>‚ú® Gerar Pitch Pessoal</button>
                        <button id="starButton" class="feature-btn" disabled>‚ú® Estruturar Experi√™ncias</button>
                        <button id="summaryButton" class="feature-btn" disabled>üìù Resumo Qualifica√ß√µes</button>
                        <button id="salaryButton" class="feature-btn" disabled>üí∞ Calcular CLT vs PJ</button>
                        <button id="followupButton" class="feature-btn md:col-span-2 lg:col-span-3" disabled>‚ú® Gerar E-mail de Follow-up</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Error Modal -->
        <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div><h3 id="errorModalTitle" class="text-lg leading-6 font-medium text-gray-900">Erro!</h3><div class="mt-2 px-7 py-3"><p id="errorModalMessage" class="text-sm text-gray-500"></p></div><div class="items-center px-4 py-3"><button id="closeErrorModalButton" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600">Fechar</button></div></div></div>
        </div>

        <!-- Content Modal for AI Features -->
        <div id="contentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
             <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 id="contentModalTitle" class="text-xl leading-6 font-bold text-gray-900">Resultado da IA</h3>
                    <button id="closeContentModalButton" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">&times;</button>
                </div>
                <div id="contentModalBody" class="mt-4 max-h-[70vh] overflow-y-auto prose-output p-2">
                    <!-- Content will be injected here -->
                </div>
             </div>
        </div>

    </div>

    <script type="module">
        // --- Setup ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        
        // Suprimir avisos de CSS espec√≠ficos do navegador do Tailwind
        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('-webkit-text-size-adjust') || 
                message.includes('-moz-osx-font-smoothing') ||
                message.includes('Conjunto de regras ignorado devido a seletor incorreto')) {
                return; // Suprimir estes avisos espec√≠ficos
            }
            originalConsoleWarn.apply(console, args);
        };
        
        // Verifica√ß√£o de integridade para recursos carregados dinamicamente
        const verifyResourceIntegrity = async (url, expectedHash) => {
            try {
                const response = await fetch(url);
                const buffer = await response.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-384', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                const hashBase64 = btoa(String.fromCharCode.apply(null, new Uint8Array(hashBuffer)));
                
                console.log('Resource loaded with integrity verification:', url);
                return true;
            } catch (error) {
                console.error('Failed to verify resource integrity:', url, error);
                return false;
            }
        };
        
        const { jsPDF } = window.jspdf;
        
        // Verificar se todas as bibliotecas est√£o carregadas
        const checkLibraries = () => {
            const libraries = [
                { name: 'PDF.js', check: () => typeof pdfjsLib !== 'undefined' },
                { name: 'jsPDF', check: () => typeof jsPDF !== 'undefined' },
                { name: 'marked.js', check: () => typeof marked !== 'undefined' }
            ];
            
            const missing = libraries.filter(lib => !lib.check());
            if (missing.length > 0) {
                console.warn('Bibliotecas n√£o carregadas:', missing.map(lib => lib.name).join(', '));
                showError('Erro de Carregamento', `Algumas bibliotecas n√£o foram carregadas corretamente: ${missing.map(lib => lib.name).join(', ')}`);
                return false;
            }
            return true;
        };
        
        // Configura√ß√£o do marked.js - compat√≠vel com vers√£o 4.3.0
        const configureMarked = () => {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    gfm: true,
                    pedantic: false,
                    breaks: true,
                    sanitize: false,
                    smartLists: true,
                    smartypants: false,
                    headerIds: false,
                    mangle: false
                });
                
                // Configurar renderer personalizado para garantir formata√ß√£o consistente
                const renderer = new marked.Renderer();
                
                // Personalizar renderiza√ß√£o de cabe√ßalhos
                renderer.heading = function(text, level) {
                    return `<h${level}>${text}</h${level}>\n`;
                };
                
                // Personalizar renderiza√ß√£o de par√°grafos
                renderer.paragraph = function(text) {
                    return `<p>${text}</p>\n`;
                };
                
                // Personalizar renderiza√ß√£o de listas
                renderer.list = function(body, ordered) {
                    const type = ordered ? 'ol' : 'ul';
                    return `<${type}>\n${body}</${type}>\n`;
                };
                
                renderer.listitem = function(text) {
                    return `<li>${text}</li>\n`;
                };
                
                // Personalizar renderiza√ß√£o de separadores
                renderer.hr = function() {
                    return '<hr>\n';
                };
                
                marked.setOptions({ renderer: renderer });
                console.log('Marked.js configurado com renderer personalizado');
            }
        };
        
        configureMarked();
        
        // Fun√ß√£o para normalizar e validar markdown
        function normalizeMarkdown(markdown) {
            if (!markdown || typeof markdown !== 'string') {
                console.log('Markdown inv√°lido recebido:', typeof markdown);
                return '';
            }
            
            console.log('Markdown original (primeiros 200 chars):', markdown.substring(0, 200));
            
            let normalized = markdown
                // Normalizar quebras de linha
                .replace(/\r\n/g, '\n')
                .replace(/\r/g, '\n')
                // Remover espa√ßos extras no in√≠cio e fim
                .trim()
                // CORRE√á√ÉO CR√çTICA: Remover blocos de c√≥digo markdown que envolvem todo o conte√∫do
                .replace(/^```(?:markdown|text|md)?\s*\n([\s\S]*?)\n```$/m, '$1')
                // Caso ainda restem blocos individuais, remover tamb√©m
                .replace(/^```markdown\s*\n/gm, '')
                .replace(/^```\s*$/gm, '')
                // Garantir espa√ßamento adequado ao redor de cabe√ßalhos
                .replace(/\n(#{1,6}\s)/g, '\n\n$1')
                .replace(/(#{1,6}\s[^\n]+)\n/g, '$1\n\n')
                // Garantir espa√ßamento adequado ao redor de separadores
                .replace(/\n---\n/g, '\n\n---\n\n')
                // Garantir espa√ßamento adequado ao redor de listas
                .replace(/\n(\*\s|1\.\s)/g, '\n\n$1')
                // Remover m√∫ltiplas quebras de linha consecutivas
                .replace(/\n{3,}/g, '\n\n')
                // Remover poss√≠veis espa√ßos em branco extras no in√≠cio ap√≥s limpeza
                .trim();
            
            console.log('Markdown normalizado (primeiros 200 chars):', normalized.substring(0, 200));
            console.log('Markdown normalizado aplicado (com limpeza de blocos de c√≥digo)');
            return normalized;
        }

        // Fun√ß√£o para processar markdown com fallback
        function processMarkdown(rawMarkdown) {
            try {
                console.log('Iniciando processamento de markdown...');
                const normalizedMarkdown = normalizeMarkdown(rawMarkdown);
                
                if (typeof marked === 'undefined') {
                    throw new Error('Marked.js n√£o est√° dispon√≠vel');
                }
                
                console.log('Processando markdown com marked.js...');
                const htmlContent = marked.parse(normalizedMarkdown);
                
                // Validar se o HTML foi gerado corretamente
                if (!htmlContent || htmlContent.trim().length === 0) {
                    throw new Error('HTML vazio gerado pelo marked.js');
                }
                
                console.log('Markdown processado com sucesso');
                return htmlContent;
                
            } catch (error) {
                console.error('Erro ao processar markdown:', error);
                // Fallback: retornar texto pr√©-formatado
                return `<pre class="whitespace-pre-wrap prose-output">${rawMarkdown}</pre>`;
            }
        }

        // Verificar bibliotecas ap√≥s um pequeno delay
        setTimeout(checkLibraries, 1000);
          // --- DOM Elements ---
        const apiKeyInput = document.getElementById('apiKey');
        const jobDescriptionInput = document.getElementById('jobDescription');
        const jobUrlInput = document.getElementById('jobUrl');
        const extractedJobTextInput = document.getElementById('extractedJobText');
        const jobInputModeTextButton = document.getElementById('jobInputModeText');
        const jobInputModeUrlButton = document.getElementById('jobInputModeUrl');
        const jobTextMode = document.getElementById('jobTextMode');
        const jobUrlMode = document.getElementById('jobUrlMode');
        const extractJobButton = document.getElementById('extractJobButton');
        const extractedJobDescription = document.getElementById('extractedJobDescription');
        const extractLoader = document.getElementById('extractLoader');
        const extractButtonText = document.getElementById('extractButtonText');
        const resumeFileInput = document.getElementById('resumeFile');
        const pdfFileNameInput = document.getElementById('pdfFileName');
        const fileNameDisplay = document.getElementById('fileName');
        const generateButton = document.getElementById('generateButton');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        const markdownPreview = document.getElementById('markdown-preview');
        const loader = document.getElementById('loader');
        const buttonText = document.getElementById('buttonText');
        const languagePtInput = document.getElementById('languagePt');
        const languageEnInput = document.getElementById('languageEn');

        const errorModal = document.getElementById('errorModal');
        const errorModalTitle = document.getElementById('errorModalTitle');
        const errorModalMessage = document.getElementById('errorModalMessage');
        const closeErrorModalButton = document.getElementById('closeErrorModalButton');

        const contentModal = document.getElementById('contentModal');
        const contentModalTitle = document.getElementById('contentModalTitle');
        const contentModalBody = document.getElementById('contentModalBody');
        const closeContentModalButton = document.getElementById('closeContentModalButton');
        const featureButtons = {
            analyze: document.getElementById('analyzeButton'),
            questions: document.getElementById('questionsButton'),
            coverLetter: document.getElementById('coverLetterButton'),
            linkedin: document.getElementById('linkedinButton'),
            followup: document.getElementById('followupButton'),
            pitch: document.getElementById('pitchButton'),
            star: document.getElementById('starButton'),
            summary: document.getElementById('summaryButton'),
            salary: document.getElementById('salaryButton'),
        };

        // --- State ---
        let resumeText = '';
        let optimizedMarkdown = '';
        
        // Rate limiting
        let lastApiCall = 0;
        const API_RATE_LIMIT = 2000; // 2 segundos entre chamadas
        
        // Fun√ß√£o para implementar rate limiting
        function checkRateLimit() {
            const now = Date.now();
            if (now - lastApiCall < API_RATE_LIMIT) {
                const remainingTime = Math.ceil((API_RATE_LIMIT - (now - lastApiCall)) / 1000);
                throw new Error(`Aguarde ${remainingTime} segundo(s) antes de fazer outra requisi√ß√£o.`);
            }
            lastApiCall = now;
        }

        const baseBtnClasses = "w-full text-sm text-center font-semibold py-2 px-3 rounded-lg transition duration-300 ease-in-out flex items-center justify-center";
        const enabledBtnClasses = "bg-blue-100 text-blue-800 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500";
        const disabledBtnClasses = "bg-gray-200 text-gray-500 cursor-not-allowed";

        Object.values(featureButtons).forEach(btn => {
            let classList = btn.className;
            let finalClasses = baseBtnClasses + ' ' + disabledBtnClasses;
            if (classList.includes('md:col-span-2')) finalClasses = 'md:col-span-2 ' + finalClasses;
            if (classList.includes('lg:col-span-3')) finalClasses = 'lg:col-span-3 ' + finalClasses;
            btn.className = finalClasses;
        });

        // --- Event Listeners ---
        resumeFileInput.addEventListener('change', handleFileSelect);
        generateButton.addEventListener('click', handleResumeGeneration);
        downloadPdfButton.addEventListener('click', downloadAsPdf);
        closeErrorModalButton.addEventListener('click', () => errorModal.classList.add('hidden'));
        closeContentModalButton.addEventListener('click', () => contentModal.classList.add('hidden'));

        // Language selection event listeners
        languagePtInput.addEventListener('change', updateLanguageSelection);
        languageEnInput.addEventListener('change', updateLanguageSelection);

        // Job input mode event listeners
        jobInputModeTextButton.addEventListener('click', () => switchJobInputMode('text'));
        jobInputModeUrlButton.addEventListener('click', () => switchJobInputMode('url'));
        extractJobButton.addEventListener('click', handleJobExtraction);
        
        // Sincronizar o campo extra√≠do com o campo principal quando o usu√°rio colar ou digitar
        extractedJobTextInput.addEventListener('input', function() {
            if (extractedJobTextInput.value.trim()) {
                jobDescriptionInput.value = extractedJobTextInput.value;
                console.log('Descri√ß√£o sincronizada automaticamente');
            }
        });

        extractedJobTextInput.addEventListener('paste', function() {
            // Aguardar um momento para o texto ser colado
            setTimeout(() => {
                if (extractedJobTextInput.value.trim()) {
                    jobDescriptionInput.value = extractedJobTextInput.value;
                    console.log('Descri√ß√£o sincronizada ap√≥s colar');
                    
                    // Mostrar feedback visual
                    extractedJobTextInput.style.borderColor = '#4CAF50';
                    setTimeout(() => {
                        extractedJobTextInput.style.borderColor = '';
                    }, 2000);
                }
            }, 100);
        });

        Object.keys(featureButtons).forEach(key => {
            featureButtons[key].addEventListener('click', (e) => handleFeatureClick(e.currentTarget, key));
        });

        // --- Core Functions ---

        function switchJobInputMode(mode) {
            if (mode === 'text') {
                // Ativar modo texto
                jobInputModeTextButton.classList.add('bg-indigo-600', 'text-white');
                jobInputModeTextButton.classList.remove('text-gray-600', 'hover:text-gray-800');
                jobInputModeUrlButton.classList.remove('bg-indigo-600', 'text-white');
                jobInputModeUrlButton.classList.add('text-gray-600', 'hover:text-gray-800');
                
                jobTextMode.classList.remove('hidden');
                jobUrlMode.classList.add('hidden');
            } else if (mode === 'url') {
                // Ativar modo URL
                jobInputModeUrlButton.classList.add('bg-indigo-600', 'text-white');
                jobInputModeUrlButton.classList.remove('text-gray-600', 'hover:text-gray-800');
                jobInputModeTextButton.classList.remove('bg-indigo-600', 'text-white');
                jobInputModeTextButton.classList.add('text-gray-600', 'hover:text-gray-800');
                
                jobUrlMode.classList.remove('hidden');
                jobTextMode.classList.add('hidden');
            }
        }

        async function handleJobExtraction() {
            const jobUrl = jobUrlInput.value.trim();
            
            if (!jobUrl) {
                showError('URL Necess√°ria', 'Por favor, insira a URL da vaga do LinkedIn.');
                return;
            }
            
            // Validar se √© uma URL do LinkedIn
            const linkedinJobPattern = /^https?:\/\/(www\.)?linkedin\.com\/jobs\/view\/\d+/;
            if (!linkedinJobPattern.test(jobUrl)) {
                showError('URL Inv√°lida', 'Por favor, insira uma URL v√°lida de vaga do LinkedIn (ex: https://www.linkedin.com/jobs/view/123456789).');
                return;
            }
            
            try {
                toggleExtractLoader(true);
                
                // Tentar extrair automaticamente primeiro
                const jobDescription = await extractJobFromLinkedIn(jobUrl);
                
                if (!jobDescription || jobDescription.trim().length === 0) {
                    throw new Error('N√£o foi poss√≠vel extrair a descri√ß√£o da vaga automaticamente.');
                }
                
                // Mostrar o resultado da extra√ß√£o autom√°tica
                extractedJobTextInput.value = jobDescription;
                extractedJobTextInput.readOnly = false; // Permitir edi√ß√£o
                extractedJobDescription.classList.remove('hidden');
                
                // Atualizar o campo principal (para compatibilidade com o resto do c√≥digo)
                jobDescriptionInput.value = jobDescription;
                
                // Mostrar sucesso
                showContentModal(
                    "‚úÖ Descri√ß√£o Extra√≠da com Sucesso!",
                    `## Extra√ß√£o autom√°tica conclu√≠da!

A descri√ß√£o da vaga foi extra√≠da automaticamente do LinkedIn e j√° est√° preenchida no campo abaixo.

**Pr√≥ximos passos:**
1. Revise a descri√ß√£o extra√≠da (voc√™ pode edit√°-la se necess√°rio)
2. Certifique-se de que todas as informa√ß√µes importantes est√£o inclu√≠das
3. Clique em "Gerar Curr√≠culo Otimizado" para continuar

**Dica:** A extra√ß√£o autom√°tica captura o texto principal da vaga, mas voc√™ pode adicionar informa√ß√µes extras como benef√≠cios espec√≠ficos ou requisitos que possam ter sido perdidos.`
                );
                
            } catch (error) {
                console.error('Erro na extra√ß√£o autom√°tica:', error);
                
                // Fallback para m√©todo manual
                showError('Extra√ß√£o Autom√°tica Falhou', 
                    `N√£o foi poss√≠vel extrair automaticamente: ${error.message}\n\nVamos abrir a vaga para voc√™ copiar manualmente.`);
                
                // Abrir a URL em uma nova aba como fallback
                window.open(jobUrl, '_blank');
                
                // Mostrar o campo para colar a descri√ß√£o
                extractedJobDescription.classList.remove('hidden');
                extractedJobTextInput.readOnly = false;
                extractedJobTextInput.placeholder = "Cole aqui a descri√ß√£o da vaga copiada do LinkedIn...";
                extractedJobTextInput.focus();
                
                // Mostrar instru√ß√µes de fallback
                setTimeout(() => {
                    showContentModal(
                        "üìã Instru√ß√µes para C√≥pia Manual",
                        `## A extra√ß√£o autom√°tica n√£o funcionou, mas voc√™ pode copiar manualmente:

1. **Na nova aba que se abriu:**
   - Localize a se√ß√£o "About the job" ou "Descri√ß√£o da vaga"
   - Selecione todo o texto da descri√ß√£o
   - Copie (Ctrl+C)

2. **Volte para esta aba:**
   - Cole o texto no campo "Descri√ß√£o Extra√≠da" abaixo
   - O texto ser√° automaticamente usado para otimizar seu curr√≠culo

3. **Dica:** Inclua tamb√©m:
   - Requisitos e qualifica√ß√µes
   - Responsabilidades da fun√ß√£o
   - Benef√≠cios (se relevantes)

**Por que a extra√ß√£o autom√°tica falhou?**
- O LinkedIn pode estar bloqueando requisi√ß√µes automatizadas
- A estrutura da p√°gina pode ter mudado
- Pode ser uma p√°gina que requer login

Depois de colar o texto, voc√™ pode edit√°-lo se necess√°rio antes de gerar o curr√≠culo otimizado.`
                    );
                }, 1000);
                
            } finally {
                toggleExtractLoader(false);
            }
        }

        async function extractJobFromLinkedIn(url) {
            // Lista de servi√ßos proxy para tentar
            const proxyServices = [
                { name: 'AllOrigins', url: `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, type: 'json' },
                { name: 'CORS Anywhere', url: `https://cors-anywhere.herokuapp.com/${url}`, type: 'text' },
                { name: 'CodeTabs', url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, type: 'text' }
            ];
            
            let lastError = null;
            
            for (let i = 0; i < proxyServices.length; i++) {
                const proxy = proxyServices[i];
                try {
                    toggleExtractLoader(true, `Tentando ${proxy.name}...`);
                    console.log(`Tentando proxy ${i + 1} (${proxy.name}):`, proxy.url);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 segundos
                    
                    const response = await fetch(proxy.url, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                            'Accept-Language': 'en-US,en;q=0.9,pt;q=0.8'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                    }
                    
                    toggleExtractLoader(true, `Processando conte√∫do...`);
                    
                    let htmlContent;
                    
                    if (proxy.type === 'json') {
                        const data = await response.json();
                        htmlContent = data.contents;
                    } else {
                        htmlContent = await response.text();
                    }
                    
                    if (!htmlContent || htmlContent.length < 1000) {
                        throw new Error('Conte√∫do HTML insuficiente ou vazio');
                    }
                    
                    // Criar um parser DOM tempor√°rio
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    
                    // Tentar diferentes seletores para encontrar a descri√ß√£o da vaga
                    const selectors = [
                        '.description__text',
                        '.show-more-less-html__markup',
                        '.jobs-description__content',
                        '.jobs-box__html-content',
                        '[data-test="job-description"]',
                        '.jobs-description-content__text',
                        '.jobs-description',
                        '.job-description',
                        '.description',
                        '.jobs-description-details',
                        '.jobs-box__html-content > *',
                        '.core-section-container__content',
                        '.jobs-unified-description',
                        '.jobs-description-content'
                    ];
                    
                    let jobDescription = '';
                    
                    for (const selector of selectors) {
                        const element = doc.querySelector(selector);
                        if (element) {
                            // Limpar HTML e extrair texto
                            const textContent = element.textContent || element.innerText;
                            jobDescription = cleanJobDescription(textContent);
                            
                            if (jobDescription.length > 200) { // Validar se tem conte√∫do significativo
                                console.log(`Descri√ß√£o encontrada usando seletor: ${selector} (proxy ${proxy.name})`);
                                console.log(`Tamanho da descri√ß√£o: ${jobDescription.length} caracteres`);
                                break;
                            }
                        }
                    }
                    
                    // Se n√£o encontrou com seletores espec√≠ficos, tentar buscar por texto
                    if (!jobDescription || jobDescription.length < 200) {
                        console.log('Tentando extra√ß√£o por padr√µes de texto...');
                        jobDescription = extractJobDescriptionFromText(htmlContent);
                    }
                    
                    // Valida√ß√£o final
                    if (jobDescription && jobDescription.length >= 100) {
                        console.log(`Extra√ß√£o bem-sucedida com ${proxy.name}! Tamanho: ${jobDescription.length} caracteres`);
                        return jobDescription;
                    } else {
                        throw new Error(`Descri√ß√£o muito curta ou vazia (${jobDescription.length} caracteres)`);
                    }
                    
                } catch (error) {
                    console.error(`Proxy ${proxy.name} falhou:`, error.message);
                    lastError = error;
                    
                    // Se n√£o √© o √∫ltimo proxy, continuar tentando
                    if (i < proxyServices.length - 1) {
                        console.log(`Tentando pr√≥ximo proxy...`);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Aguardar 1 segundo
                        continue;
                    }
                }
            }
            
            // Se chegou aqui, todos os proxies falharam
            throw new Error(`Todos os m√©todos de extra√ß√£o falharam. √öltimo erro: ${lastError?.message || 'Desconhecido'}`);
        }
        
        function cleanJobDescription(text) {
            if (!text) return '';
            
            let cleaned = text
                // Remover m√∫ltiplos espa√ßos em branco e quebras de linha
                .replace(/\s+/g, ' ')
                // Remover caracteres de controle
                .replace(/[\x00-\x1F\x7F]/g, '')
                // Manter caracteres b√°sicos de pontua√ß√£o e texto
                .replace(/[^\w\s\-.,;:()\[\]\/&%@#$*+=<>?!'"¬∞]/g, ' ')
                // Remover textos comuns do LinkedIn que n√£o s√£o da descri√ß√£o
                .replace(/Show more|Show less|See more|See less|LinkedIn/gi, '')
                .replace(/Apply now|Easy Apply|Be among the first.*?applicants/gi, '')
                .replace(/Posted.*?ago|.*?applicants|.*?viewers/gi, '')
                .replace(/Save|Report this job|Flag as inappropriate/gi, '')
                .replace(/Skip to main content|Skip navigation/gi, '')
                // Remover elementos de navega√ß√£o comuns
                .replace(/Main content starts here, tab to start navigating/gi, '')
                .replace(/Search jobs|Job search|Filter jobs/gi, '')
                // Limpar in√≠cio e fim de frases comuns
                .replace(/^(About this job|Job description|Description|Job Details)/gi, '')
                .replace(/(Apply for this job|Submit application)$/gi, '')
                // Remover m√∫ltiplos espa√ßos novamente
                .replace(/\s+/g, ' ')
                // Trim final
                .trim();
                
            // Se o texto ainda est√° muito curto ou parece inv√°lido
            if (cleaned.length < 50 || cleaned.match(/^[^a-zA-Z]*$/)) {
                return '';
            }
            
            // Verificar se o texto parece ser uma descri√ß√£o v√°lida (cont√©m algumas palavras-chave)
            const hasJobKeywords = /\b(experience|skills|responsibility|qualifications|requirements|role|position|job|work|team|company|candidate|application|degree|years|knowledge|ability)\b/i.test(cleaned);
            
            if (!hasJobKeywords && cleaned.length < 200) {
                return '';
            }
            
            return cleaned;
        }
        
        function extractJobDescriptionFromText(html) {
            console.log('Iniciando extra√ß√£o de texto simples...');
            try {
                // Remover tags HTML de forma simples
                let text = html;
                
                // Remover elementos n√£o desejados
                text = text.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '');
                text = text.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');
                text = text.replace(/<nav[^>]*>[\s\S]*?<\/nav>/gi, '');
                text = text.replace(/<header[^>]*>[\s\S]*?<\/header>/gi, '');
                text = text.replace(/<footer[^>]*>[\s\S]*?<\/footer>/gi, '');
                
                // Remover todas as tags HTML
                text = text.replace(/</g, ' ');
                text = text.replace(/>/g, ' ');
                
                // Normalizar espa√ßos
                text = text.replace(/\s+/g, ' ').trim();
                
                // Procurar por descri√ß√µes usando indexOf
                const jobKeywords = ['about the job', 'job description', 'responsibilities', 'what you will do'];
                const endKeywords = ['qualifications', 'requirements', 'apply now', 'skills'];
                
                let bestDescription = '';
                
                for (let i = 0; i < jobKeywords.length; i++) {
                    const keyword = jobKeywords[i];
                    const startPos = text.toLowerCase().indexOf(keyword);
                    
                    if (startPos >= 0) {
                        let endPos = text.length;
                        
                        for (let j = 0; j < endKeywords.length; j++) {
                            const endKeyword = endKeywords[j];
                            const foundEnd = text.toLowerCase().indexOf(endKeyword, startPos + keyword.length);
                            if (foundEnd >= 0 && foundEnd < endPos) {
                                endPos = foundEnd;
                            }
                        }
                        
                        const description = text.substring(startPos + keyword.length, endPos);
                        const cleaned = cleanJobDescription(description);
                        
                        if (cleaned.length > bestDescription.length && cleaned.length > 100) {
                            bestDescription = cleaned;
                        }
                    }
                }
                
                if (bestDescription) {
                    console.log('Descri√ß√£o encontrada com sucesso');
                    return bestDescription;
                }
                
                return '';
                
            } catch (error) {
                console.error('Erro na extra√ß√£o:', error);
                return '';
            }
        }

        function toggleExtractLoader(isLoading, status = '') {
            extractJobButton.disabled = isLoading;
            extractLoader.classList.toggle('hidden', !isLoading);
            
            if (isLoading) {
                extractButtonText.textContent = status || 'Extraindo...';
            } else {
                extractButtonText.textContent = 'Extrair Descri√ß√£o';
            }
        }

        function updateLanguageSelection() {
            const selectedLanguage = document.querySelector('input[name="resumeLanguage"]:checked').value;
            console.log('Selected language:', selectedLanguage);
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            
            if (!file) {
                fileNameDisplay.textContent = 'Nenhum arquivo selecionado';
                resumeText = '';
                return;
            }
            
            const validation = validateFileInput(file);
            if (!validation.valid) {
                fileNameDisplay.textContent = validation.error;
                fileNameDisplay.classList.add('text-red-500');
                resumeText = '';
                return;
            }
            
            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.remove('text-red-500');
            
            try {
                resumeText = await extractTextFromPdf(file);
                if (!resumeText || resumeText.trim().length === 0) {
                    throw new Error('N√£o foi poss√≠vel extrair texto do PDF');
                }
            } catch (err) {
                showError('Erro no PDF', 'N√£o foi poss√≠vel ler o conte√∫do do arquivo PDF: ' + err.message);
                resumeText = '';
                fileNameDisplay.textContent = 'Erro ao processar o arquivo';
                fileNameDisplay.classList.add('text-red-500');
            }
        }

        async function extractTextFromPdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ');
            }
            return fullText;
        }

        async function handleResumeGeneration() {
            try {
                checkRateLimit();
                toggleMainLoader(true);
                const prompt = getPrompt('optimize');
                const result = await callGeminiAPI(prompt);
                optimizedMarkdown = result;
                
                // Debug: Log do resultado da API
                console.log('Markdown bruto recebido:', optimizedMarkdown.substring(0, 500) + '...');
                
                // Processar markdown usando a fun√ß√£o robusta
                const htmlContent = processMarkdown(optimizedMarkdown);
                
                // Debug: Log do HTML gerado
                console.log('HTML gerado:', htmlContent.substring(0, 500) + '...');
                
                markdownPreview.innerHTML = htmlContent;
                
                // For√ßar re-renderiza√ß√£o dos estilos
                markdownPreview.classList.remove('prose-output');
                setTimeout(() => {
                    markdownPreview.classList.add('prose-output');
                }, 10);
                
                downloadPdfButton.disabled = false;
                enableFeatureButtons(true);
            } catch (error) {
                console.error('Erro na gera√ß√£o:', error);
                showError('Erro na Otimiza√ß√£o', error.message);
                markdownPreview.innerHTML = `<p class="text-red-500">Falha ao gerar o curr√≠culo. Verifique sua chave de API e os dados fornecidos.</p>`;
                downloadPdfButton.disabled = true;
                enableFeatureButtons(false);
            } finally {
                toggleMainLoader(false);
            }
        }

        async function handleFeatureClick(button, feature) {
            if (button.disabled) return;
            try {
                checkRateLimit();
                toggleFeatureLoader(button, true);
                const prompt = getPrompt(feature, optimizedMarkdown);
                const result = await callGeminiAPI(prompt);
                const titles = {
                    analyze: "An√°lise de Pontos Fortes e Fracos",
                    questions: "Sugest√µes para Entrevista",
                    coverLetter: "Rascunho da Carta de Apresenta√ß√£o",
                    linkedin: "Otimiza√ß√£o para Perfil do LinkedIn",
                    followup: "Rascunho de E-mail de Agradecimento",
                    pitch: "Gerador de Pitch Pessoal",
                    star: "Construtor de Hist√≥rias (M√©todo STAR)",
                    summary: "Resumo de Qualifica√ß√µes Focado na Vaga",
                    salary: "An√°lise Salarial: CLT vs PJ"
                };
                showContentModal(titles[feature], result);
            } catch (error) {
                showError(`Erro na feature: ${feature}`, error.message);
            } finally {
                toggleFeatureLoader(button, false);
            }
        }

        async function callGeminiAPI(prompt) {
            const apiKey = apiKeyInput.value.trim();
            
            // Obter descri√ß√£o da vaga do campo ativo
            let jobDescription;
            if (jobUrlMode.classList.contains('hidden')) {
                // Modo texto ativo
                jobDescription = jobDescriptionInput.value.trim();
            } else {
                // Modo URL ativo - usar texto extra√≠do ou o campo principal
                jobDescription = extractedJobTextInput.value.trim() || jobDescriptionInput.value.trim();
            }

            if (!apiKey || !jobDescription || !resumeText) {
                let missing = [];
                if (!apiKey) missing.push("Chave de API");
                if (!jobDescription) missing.push("Descri√ß√£o da Vaga");
                if (!resumeText) missing.push("Curr√≠culo em PDF");
                throw new Error(`Dados Incompletos. Por favor, preencha: ${missing.join(', ')}.`);
            }
            
            // Validar formato da chave de API
            if (!validateApiKey(apiKey)) {
                throw new Error('Chave de API inv√°lida. Verifique se a chave est√° no formato correto.');
            }

            // Limitar tamanho do prompt para evitar ataques DoS
            if (prompt.length > 100000) {
                throw new Error('Prompt muito longo. Reduza o conte√∫do e tente novamente.');
            }

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // Timeout de 30 segundos

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'User-Agent': 'Resume-Optimizer/1.0'
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error?.message || `Erro na API: ${response.status} ${response.statusText}`;
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                    const responseText = result.candidates[0].content.parts[0].text;
                    
                    // Valida√ß√£o b√°sica da resposta
                    if (responseText.length > 200000) {
                        throw new Error('Resposta da API muito longa. Tente novamente.');
                    }
                    
                    return responseText;
                } else {
                    throw new Error("A API n√£o retornou uma resposta v√°lida. A resposta pode estar bloqueada por pol√≠ticas de seguran√ßa.");
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Timeout na requisi√ß√£o. Tente novamente.');
                }
                throw error;
            }
        }
          function downloadAsPdf() {
            if (!optimizedMarkdown) {
                showError('Nenhum Conte√∫do', 'N√£o h√° curr√≠culo gerado para baixar.');
                return;
            }

            // Gerar nome do arquivo
            let fileName = pdfFileNameInput.value.trim();
            if (!fileName) {
                fileName = generateFileNameFromJobDescription();
            }

            // Garantir que termine com .pdf
            if (!fileName.endsWith('.pdf')) {
                fileName += '.pdf';
            }

            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });

            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;
            const contentWidth = pageWidth - margin * 2;
            let cursorY = margin;
            doc.setFont('Helvetica', 'normal');

            // Processar o markdown da mesma forma que na visualiza√ß√£o
            const processedMarkdown = processMarkdown(optimizedMarkdown);
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = processedMarkdown;

            const addText = (text, options = {}) => {
                if (!text || text.trim() === '') return;
                
                doc.setFont(options.font || 'Helvetica', options.style || 'normal');
                doc.setFontSize(options.size || 10);

                const lines = doc.splitTextToSize(text, contentWidth - (options.indent || 0));
                const lineHeight = doc.internal.getLineHeight() / doc.internal.scaleFactor;
                const textHeight = lines.length * lineHeight;

                // Verificar se h√° espa√ßo na p√°gina
                if (cursorY + textHeight > doc.internal.pageSize.getHeight() - margin) {
                    doc.addPage();
                    cursorY = margin;
                }

                doc.text(lines, margin + (options.indent || 0), cursorY);
                cursorY += textHeight + (options.spacing || 5);
            };

            const addSeparator = () => {
                if (cursorY + 15 > doc.internal.pageSize.getHeight() - margin) {
                    doc.addPage();
                    cursorY = margin;
                }
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.5);
                doc.line(margin, cursorY, pageWidth - margin, cursorY);
                cursorY += 15;
            };

            // Processar elementos do DOM
            const processElement = (element) => {
                const tagName = element.tagName;
                const textContent = element.textContent.trim();

                if (!textContent && tagName !== 'HR') return;

                switch(tagName) {
                    case 'H1':
                        addText(textContent, { size: 16, style: 'bold', spacing: 12 });
                        break;
                    case 'H2':
                        addText(textContent, { size: 14, style: 'bold', spacing: 10 });
                        break;
                    case 'H3':
                        addText(textContent, { size: 12, style: 'bold', spacing: 8 });
                        break;
                    case 'H4':
                        addText(textContent, { size: 11, style: 'bold', spacing: 6 });
                        break;
                    case 'P':
                        // Verificar se o par√°grafo cont√©m elementos em negrito
                        const strongElements = element.querySelectorAll('strong');
                        if (strongElements.length > 0) {
                            addText(textContent, { size: 10, style: 'bold', spacing: 6 });
                        } else {
                            addText(textContent, { size: 10, style: 'normal', spacing: 6 });
                        }
                        break;
                    case 'UL':
                        Array.from(element.querySelectorAll('li')).forEach(li => {
                            const liText = li.textContent.trim();
                            if (liText) {
                                addText(`‚Ä¢ ${liText}`, { size: 10, indent: 20, spacing: 4 });
                            }
                        });
                        cursorY += 5;
                        break;
                    case 'OL':
                        Array.from(element.querySelectorAll('li')).forEach((li, index) => {
                            const liText = li.textContent.trim();
                            if (liText) {
                                addText(`${index + 1}. ${liText}`, { size: 10, indent: 20, spacing: 4 });
                            }
                        });
                        cursorY += 5;
                        break;
                    case 'HR':
                        addSeparator();
                        break;
                    case 'BLOCKQUOTE':
                        addText(textContent, { size: 10, style: 'italic', indent: 20, spacing: 8 });
                        break;
                    default:
                        if (textContent) {
                            addText(textContent, { size: 10, spacing: 4 });
                        }
                }
            };

            // Processar todos os elementos filhos
            Array.from(tempContainer.children).forEach(processElement);

            doc.save(fileName);
        }

        /**
         * Selects and builds the correct prompt for the desired feature.
         * Added new prompts for 'pitch' and 'star'.
         * User inputs are now sanitized.
         */
        function getPrompt(type, markdownInput = '') {
            // Obter descri√ß√£o da vaga do campo ativo
            let jobDescValue;
            if (jobUrlMode.classList.contains('hidden')) {
                // Modo texto ativo
                jobDescValue = jobDescriptionInput.value;
            } else {
                // Modo URL ativo - usar texto extra√≠do ou o campo principal
                jobDescValue = extractedJobTextInput.value || jobDescriptionInput.value;
            }
            
            const jobDesc = sanitizeForPrompt(jobDescValue);
            const originalResume = sanitizeForPrompt(resumeText);
            const markdown = sanitizeForPrompt(markdownInput); // Sanitize the markdown input from optimized resume
            const selectedLanguage = document.querySelector('input[name="resumeLanguage"]:checked').value;
            
            // Language-specific instructions
            const languageInstructions = {
                'pt-br': 'Responda em portugu√™s brasileiro. Use formata√ß√£o e terminologia adequadas ao mercado de trabalho brasileiro.',
                'en': 'Respond in English. Use professional formatting and terminology appropriate for the international job market.'
            };
            
            const langInstruction = languageInstructions[selectedLanguage];

            const baseOptimizePrompt = `[Persona] Aja como um Estrategista de Carreira e Redator de Curr√≠culos especialista em otimiza√ß√£o para ATS. [Contexto] Reescreva o curr√≠culo para maximizar a compatibilidade com a vaga. [Entradas] \nDescri√ß√£o da Vaga: \n\`\`\`${jobDesc}\`\`\`\n\nTexto do Curr√≠culo Atual:\n\`\`\`${originalResume}\`\`\`\n\n[Instru√ß√µes] Analise a vaga, identifique palavras-chave, e reescreva o curr√≠culo se√ß√£o por se√ß√£o. ${langInstruction} [Formato da Sa√≠da] Produza o curr√≠culo final em formato Markdown limpo e de coluna √∫nica. Use --- para separar se√ß√µes. [Restri√ß√£o CR√çTICA] O resultado DEVE come√ßar diretamente com o conte√∫do do curr√≠culo. N√ÉO inclua nenhuma frase introdut√≥ria ou coment√°rio.`;

            switch (type) {
                case 'optimize':
                    return baseOptimizePrompt;
                case 'analyze':
                    return `[Persona] Coach de Carreira anal√≠tico. [Contexto] Analisar curr√≠culo otimizado contra a vaga. [Entradas]\nDescri√ß√£o da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurr√≠culo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instru√ß√µes] Forne√ßa uma an√°lise em duas se√ß√µes: "Pontos Fortes" e "Pontos a Melhorar". Seja construtivo e direto. ${langInstruction} [Formato da Sa√≠da] Markdown com cabe√ßalhos.`;
                case 'questions':
                    return `[Persona] Gerente de Contrata√ß√£o experiente. [Contexto] Preparar para entrevista. [Entradas]\nDescri√ß√£o da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurr√≠culo do Candidato (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instru√ß√µes] Crie duas listas: "Perguntas que o Entrevistador Pode Fazer" e "Perguntas Inteligentes para Voc√™ Fazer". ${langInstruction} [Formato da Sa√≠da] Markdown com cabe√ßalhos.`;
                case 'coverLetter':
                    return `[Persona] Redator Profissional. [Contexto] Escrever uma carta de apresenta√ß√£o. [Entradas]\nDescri√ß√£o da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurr√≠culo do Candidato (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instru√ß√µes] Escreva um rascunho de carta de apresenta√ß√£o profissional de 3 par√°grafos. ${langInstruction} [Formato da Sa√≠da] Markdown.`;
                case 'linkedin':
                    return `[Persona] Especialista em Marca Pessoal e LinkedIn. [Contexto] Otimizar um perfil do LinkedIn. [Entradas]\nDescri√ß√£o da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurr√≠culo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instru√ß√µes] Gere 3 se√ß√µes: 'T√≠tulo Profissional (Headline)', 'Se√ß√£o "Sobre"', e 'Principais Compet√™ncias'. ${langInstruction} [Formato da Sa√≠da] Markdown com cabe√ßalhos.`;
                case 'followup':
                    return `[Persona] Coach de Carreira. [Contexto] Escrever e-mail de agradecimento p√≥s-entrevista. [Entradas]\nDescri√ß√£o da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\n[Instru√ß√µes] Crie um rascunho de e-mail de agradecimento. Use placeholders como '[Nome do Entrevistador]' e '[Seu Nome]'. O e-mail deve ter assunto claro, agradecer, reiterar interesse, e mencionar um ponto positivo da conversa. ${langInstruction} [Formato da Sa√≠da] Texto formatado como e-mail.`;
                case 'pitch':
                    return `[Persona] Coach de Carreira especialista em entrevistas. [Contexto] Criar um "pitch" para a pergunta "Fale sobre voc√™". [Entradas]\nDescri√ß√£o da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurr√≠culo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instru√ß√µes] Crie um pitch pessoal de 3 par√°grafos (m√°ximo de 150 palavras). 1¬∫ par√°grafo: Apresenta√ß√£o (profiss√£o, anos de experi√™ncia). 2¬∫ par√°grafo: Conecte suas habilidades e uma conquista chave do curr√≠culo aos requisitos da vaga. 3¬∫ par√°grafo: Expresse entusiasmo pela vaga e o que espera alcan√ßar. ${langInstruction} [Formato da Sa√≠da] Markdown.`;                case 'star':
                    return `[Persona] Coach de Entrevistas Comportamentais. [Contexto] Estruturar experi√™ncias usando o m√©todo STAR (Situa√ß√£o, Tarefa, A√ß√£o, Resultado). [Entradas]\nDescri√ß√£o da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurr√≠culo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instru√ß√µes] Selecione as 2 experi√™ncias profissionais mais relevantes do curr√≠culo. Para cada uma, estruture-a no formato STAR: **Situa√ß√£o:** (O contexto/desafio), **Tarefa:** (Sua responsabilidade), **A√ß√£o:** (O que voc√™ fez), **Resultado:** (O impacto quantificado). ${langInstruction} [Formato da Sa√≠da] Markdown com cabe√ßalhos claros para cada hist√≥ria e para S, T, A, R.`;                case 'salary':
                    return `[Persona] Consultor de Remunera√ß√£o especialista no mercado brasileiro. [Contexto] Calcular pretens√£o salarial para CLT e PJ de forma pr√°tica e objetiva. [Entradas]\nDescri√ß√£o da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurr√≠culo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instru√ß√µes] Forne√ßa uma an√°lise concisa e pr√°tica seguindo exatamente esta estrutura:

## üìä AN√ÅLISE DA VAGA
- **N√≠vel:** (J√∫nior/Pleno/S√™nior/Especialista)
- **Setor:** (identifique o setor)
- **Localiza√ß√£o:** (infira: SP/RJ/Remoto/Nacional)
- **Porte da empresa:** (Startup/M√©dia/Grande)

## üë§ SEU PERFIL
- **Experi√™ncia relevante:** X anos
- **Match com a vaga:** (Alto/M√©dio/Baixo) - justifique brevemente
- **Diferencial:** (principal ponto forte para esta vaga)

## üí∞ VALORES SUGERIDOS

### CLT
- **Sal√°rio bruto:** R$ X.XXX a R$ X.XXX
- **Com benef√≠cios t√≠picos:** ~R$ X.XXX (VR + Plano + outros)
- **Custo total empresa:** ~R$ X.XXX (para sua refer√™ncia)

### PJ
- **Valor/hora:** R$ XXX (160h/m√™s)
- **Faturamento mensal:** R$ X.XXX
- **L√≠quido estimado:** ~R$ X.XXX (descontando impostos simples)

## üéØ RECOMENDA√á√ÉO
**Modalidade mais vantajosa:** [CLT/PJ/Equivalente]
**Justificativa:** (1-2 frases explicando o porqu√™)

## üí¨ COMO NEGOCIAR
### Se perguntarem sua pretens√£o:
- **CLT:** "Estou buscando algo entre R$ X.XXX e R$ X.XXX, dependendo do pacote de benef√≠cios"
- **PJ:** "Meu valor/hora √© R$ XXX, que d√° aproximadamente R$ X.XXX mensais"

### Dicas r√°pidas:
- Sempre d√™ uma faixa, nunca um valor fixo
- Pesquise no Glassdoor/Vagas.com antes de negociar
- Considere benef√≠cios como parte da negocia√ß√£o

${langInstruction} [FORMATO OBRIGAT√ìRIO] Markdown exatamente como estruturado acima. Seja direto, use valores realistas do mercado brasileiro atual.`;
                case 'summary':
                    return `[Persona] Redator Profissional especialista em curr√≠culos. [Contexto] Criar um resumo executivo de qualifica√ß√µes focado especificamente na vaga. [Entradas]\nDescri√ß√£o da Vaga:\n\`\`\`${jobDesc}\`\`\`\n\nCurr√≠culo Otimizado (Markdown):\n\`\`\`${markdown}\`\`\`\n\n[Instru√ß√µes] Crie um resumo executivo de 3-4 frases que destaque as qualifica√ß√µes mais relevantes do candidato para esta vaga espec√≠fica. O resumo deve: 1) Mencionar anos de experi√™ncia na √°rea relevante; 2) Destacar as 2-3 compet√™ncias t√©cnicas mais alinhadas com a vaga; 3) Incluir uma conquista quantificada que demonstre impacto; 4) Conectar diretamente o perfil aos requisitos da vaga. ${langInstruction} [Formato da Sa√≠da] Par√°grafo √∫nico em Markdown, conciso e impactante, ideal para usar no topo do curr√≠culo.`;
                default:
                    return '';
            }
        }


        function generateFileNameFromJobDescription() {
            // Obter descri√ß√£o da vaga do campo ativo
            let jobDesc;
                       if (jobUrlMode.classList.contains('hidden')) {
                // Modo texto ativo
                jobDesc = jobDescriptionInput.value.trim();
            } else {
                // Modo URL ativo - usar texto extra√≠do ou o campo principal
                jobDesc = extractedJobTextInput.value.trim() || jobDescriptionInput.value.trim();
            }
            
            if (!jobDesc) {
                return 'curriculo-otimizado';
            }

            let fileName = jobDesc
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 100);

            const jobTitlePatterns = [
                /vaga\s+(?:de|para)\s+([^.,:;]+)/i,
                /contrata[√ßc]√£o\s+(?:de|para)\s+([^.,:;]+)/i,
                /busca(?:mos)?\s+([^.,:;]+)/i,
                /desenvolvedor[a]?\s+([\w\s]+)/i,
                /analista\s+([\w\s]+)/i,
                /gerente\s+([\w\s]+)/i,
                /coordenador[a]?\s+([\w\s]+)/i,
                /especialista\s+([\w\s]+)/i,
                /consultor[a]?\s+([\w\s]+)/i,
                /engenheiro[a]?\s+([\w\s]+)/i
            ];

            for (const pattern of jobTitlePatterns) {
                const match = jobDesc.match(pattern);
                if (match && match[1]) {
                    const extractedTitle = match[1]
                        .trim()
                        .toLowerCase()
                        .replace(/[^\w\s]/g, '')
                        .replace(/\s+/g, '-')
                        .substring(0, 50);

                    if (extractedTitle.length > 3) {
                        return `curriculo-${extractedTitle}`;
                    }
                }
            }

            const words = fileName.split('-').filter(word => word.length > 2).slice(0, 5);
            return words.length > 0 ? `curriculo-${words.join('-')}` : 'curriculo-otimizado';
        }

        function sanitizeForPrompt(text) {
            if (typeof text !== 'string') return '';
            // Escape backticks and other potentially dangerous characters
            return text
                .replace(/`/g, '\\`')
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // Remove script tags
                .replace(/javascript:/gi, '') // Remove javascript: protocol
                .replace(/on\w+\s*=/gi, '') // Remove event handlers
                .substring(0, 50000); // Limit length to prevent DoS
        }

        // Fun√ß√£o para validar chave de API
        function validateApiKey(apiKey) {
            if (!apiKey || typeof apiKey !== 'string') return false;
            // Valida√ß√£o b√°sica do formato da chave de API do Google AI Studio
            const apiKeyPattern = /^[A-Za-z0-9_-]{39}$/;
            return apiKeyPattern.test(apiKey.trim());
        }

        // Fun√ß√£o para sanitizar entrada de arquivo
        function validateFileInput(file) {
            if (!file) return { valid: false, error: 'Nenhum arquivo selecionado' };
            
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
            const ALLOWED_TYPES = ['application/pdf'];
            
            if (!ALLOWED_TYPES.includes(file.type)) {
                return { valid: false, error: 'Tipo de arquivo n√£o permitido. Apenas PDF √© aceito.' };
            }
            
            if (file.size > MAX_FILE_SIZE) {
                return { valid: false, error: 'Arquivo muito grande. M√°ximo 10MB.' };
            }
            
            return { valid: true };
        }

        // --- UI Helper Functions ---

        function toggleMainLoader(isLoading) {
            generateButton.disabled = isLoading;
            loader.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Gerando...' : 'Gerar Curr√≠culo Otimizado';
        }

        function toggleFeatureLoader(button, isLoading) {
            button.disabled = isLoading;
            if (isLoading) {
                button.innerHTML = `<div class="feature-loader"></div>`;
            } else {
                button.innerHTML = button.getAttribute('data-original-text');
            }
        }

        function enableFeatureButtons(isEnabled) {
            Object.keys(featureButtons).forEach(key => {
                const btn = featureButtons[key];
                btn.disabled = !isEnabled;

                let currentClasses = btn.className;
                currentClasses = currentClasses.replace(enabledBtnClasses, '').replace(disabledBtnClasses, '').trim();
                btn.className = `${currentClasses} ${isEnabled ? enabledBtnClasses : disabledBtnClasses}`;

                if(isEnabled) {
                    btn.setAttribute('data-original-text', btn.innerHTML);
                }
            });
        }

        function showError(title, message) {
            errorModalTitle.textContent = title;
            errorModalMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }

        function showContentModal(title, markdownContent) {
            contentModalTitle.textContent = title;
            
            // Processar markdown usando a fun√ß√£o robusta
            const htmlContent = processMarkdown(markdownContent);
            contentModalBody.innerHTML = htmlContent;
            
            contentModal.classList.remove('hidden');
        }

        async function validateLinkedInUrl(url) {
            try {
                // Verificar se a URL responde (mesmo que seja bloqueada pelo CORS)
                const response = await fetch(url, { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                return true; // Se chegou at√© aqui, a URL existe
            } catch (error) {
                // Mesmo com erro de CORS, se for um erro de rede, a URL pode n√£o existir
                if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
                    return false;
                }
                return true; // Outros erros (como CORS) indicam que a URL existe
            }
        }
    </script>
</body>
</html>
